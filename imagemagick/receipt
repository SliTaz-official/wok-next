# SliTaz package receipt v2.

PACKAGE="imagemagick"
VERSION="7.0.6-10"
CATEGORY="graphics"
SHORT_DESC="ImageMagick - convert, edit, and compose images"
MAINTAINER="pankso@slitaz.org"
LICENSE="Apache"
WEB_SITE="https://www.imagemagick.org/script/index.php"
LFS="http://www.linuxfromscratch.org/blfs/view/stable/general/imagemagick.html"

TARBALL="ImageMagick-$VERSION.tar.xz"
WGET_URL="https://www.imagemagick.org/download/releases/$TARBALL"

BUILD_DEPENDS="bzip2-dev xorg-libX11-dev xorg-libICE-dev xorg-libXext-dev \
xorg-libXt-dev zlib-dev libtool fftw-dev fontconfig-dev freetype-dev \
libjpeg-turbo-dev lcms2-dev xz-dev pango-dev libpng16-dev tiff-dev \
libxml2-dev librsvg-dev perl-dev util-linux-uuid-dev jasper-dev ilmbase-dev \
openexr-dev libgsf-dev libcroco-dev" # graphviz-dev
SPLIT="perl-image-magick imagemagick imagemagick-dev"

compile_rules() {
	./configure \
		--with-perl \
		--with-magick-plus-plus \
		--with-modules \
		--enable-hdri \
		--with-rsvg \
		--disable-static \
		$CONFIGURE_ARGS &&
	fix libtool &&
	make $MAKEFLAGS &&
	make DESTDIR=$DESTDIR install || return 1

	chmod -R u+w $install/usr/lib/perl5/
}

genpkg_rules() {
	case $PACKAGE in
		perl-image-magick)
			copy perl5/
			CAT="perl|Image::Magick Perl module"
			DEPENDS="imagemagick perl"
			;;
		imagemagick)
			copy @std @rm *.la

			# CVE-2016-3714 work around v5
			sed -i '/<policymap>/r/dev/stdin' $fs/etc/ImageMagick-7/policy.xml <<EOT
  <policy domain="coder" rights="none" pattern="EPHEMERAL" />
  <policy domain="coder" rights="none" pattern="URL" />
  <policy domain="coder" rights="none" pattern="HTTPS" />
  <policy domain="coder" rights="none" pattern="MVG" />
  <policy domain="coder" rights="none" pattern="MSL" />
  <policy domain="coder" rights="none" pattern="TEXT" />
  <policy domain="coder" rights="none" pattern="SHOW" />
  <policy domain="coder" rights="none" pattern="WIN" />
  <policy domain="coder" rights="none" pattern="PLT" />
EOT
			DEPENDS="bzlib cairo fftw fontconfig freetype glib lcms2 libgomp \
			libjpeg-turbo libltdl liblzma libpng16 librsvg libxml2 openexr \
			pango tiff xorg-libX11 xorg-libXext zlib"
			TAGS="image photo toolkit"
			;;
		*-dev)
			copy @dev
			DEPENDS="imagemagick \
			bzip2-dev fftw-dev fontconfig-dev freetype-dev lcms2-dev libgomp \
			libltdl xorg-libICE-dev xorg-libSM-dev xorg-libX11-dev \
			xorg-libXext-dev xorg-libXt-dev xz-dev zlib-dev"
			;;
	esac
}
