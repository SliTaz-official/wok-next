# SliTaz package receipt v2.

PACKAGE="partimage"
VERSION="0.6.9"
CATEGORY="system-tools"
SHORT_DESC="Saves partitions in an image file"
MAINTAINER="erjo@slitaz.org"
LICENSE="GPL2"
TARBALL="$PACKAGE-$VERSION.tar.bz2"
WEB_SITE="http://www.partimage.org/Index.fr.html"
WGET_URL="$SF_MIRROR/$PACKAGE/$TARBALL"

BUILD_DEPENDS="newt newt-dev slang-dev bzip2-dev openssl-dev zlib-dev pam-dev"
SPLIT="partimage partimage-pam:pam"

compile_rules() {
	case $SET in
		'')  SET_ARGS='--disable-pam';;
		pam) SET_ARGS='--enable-pam';;
	esac

	sed -i 's/gzFile \*m_gzImageFile/gzFile m_gzImageFile/' src/client/imagefile.h
	sed -i 's/(gzFile \*) gzdopen/gzdopen/' src/client/imagefile.cpp

	./configure \
		$SET_ARGS \
		$CONFIGURE_ARGS &&
	make &&
	make DESTDIR=$DESTDIR install || return 1

	install -Dm600 $stuff/etc/partimaged/partimaged.cert $install/etc/partimaged/partimaged.cert
	install -Dm600 $stuff/etc/partimaged/partimaged.key  $install/etc/partimaged/partimaged.key
	install -Dm755 $stuff/etc/init.d/partimaged          $install/etc/init.d/partimaged

	mkdir -p $install/var/lib/partimaged/
}

genpkg_rules() {
	case $PACKAGE in
		partimage)
			copy @std
			DEPENDS="newt bzip2 openssl slitaz-base-files zlib gcc-lib-base"
			;;
		partimage-pam)
			copy @std
			CAT="system-tools|using PAM"
			PROVIDE="partimage:pam"
			DEPENDS="newt bzip2 openssl slitaz-base-files zlib pam gcc-lib-base"
			;;
	esac
}

# The same post-install/remove rules for both PAM/non-PAM packages

post_install() {
	# Adding user/group partimag...
	chroot "$1/" adduser -S -H -D partimag

	# Setting permissions for config files
	chmod 0600 "$1"/etc/partimaged/*
	chroot "$1/" chown partimag.partimag "$1"/etc/partimaged/*

	# Creating image files directory
	chroot "$1/" install -g partimag -o partimag -m 0755 -d "$1/var/lib/partimaged"

	[ -n "$quiet" ] || cat <<EOT

	.---------------------------------------------------.
	| To starts partimage server you can run:           |
	|   /etc/init.d/partimaged start                    |
	|                                                   |
	| Or add partimaged to RUN_DAEMONS in /etc/rcS.conf |
	'---------------------------------------------------'
EOT
}

post_remove() {
	chroot "$1/" deluser  partimag
	chroot "$1/" delgroup partimag

	if [ -f "$1/etc/paritimaged" ]; then
		rm -rf "$1/etc/partimaged"
	fi
}
