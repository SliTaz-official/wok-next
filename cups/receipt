# SliTaz package receipt v2.

PACKAGE="cups"
VERSION="2.2.2"
CATEGORY="system-tools"
SHORT_DESC="Common UNIX Printing System"
MAINTAINER="erjo@slitaz.org"
LICENSE="GPL2 LGPL2"
WEB_SITE="https://www.cups.org/"

TARBALL="cups-$VERSION-source.tar.gz"
WGET_URL="https://github.com/apple/cups/releases/download/v$VERSION/$TARBALL"

BUILD_DEPENDS="automake libusb-dev zlib-dev acl-dev dbus-dev gnutls-dev perl \
python pam pam-dev"
SPLIT="libcups cups cups-pam cups-doc cups-dev"

# Rules to configure and make the package.
compile_rules()
{
	# gid 19 suggested by the BLFS is in use in SliTaz (by cdrom group),
	# using 23 instead
	addgroup -g 23 lpadmin

	sed -i 's:555:755:g;s:444:644:g' Makedefs.in
	sed -i '/MAN.EXT/s:.gz::g' configure config-scripts/cups-manpages.m4
	sed -i '/LIBGCRYPTCONFIG/d' config-scripts/cups-ssl.m4

	aclocal  -I config-scripts
	autoconf -I config-scripts

	cp -a $src $src-pam

	CC=gcc \
	./configure \
		--sysconfdir=/etc \
		--libdir=/usr/lib \
		--localstatedir=/var \
		--disable-pam \
		--disable-systemd \
		--with-rcdir=/tmp/cupsinit \
		--with-system-groups=lpadmin \
		--with-docdir=/usr/share/doc/cups-$VERSION \
		$CONFIGURE_ARGS &&
	make &&
	make BUILDROOT=$install install || return 1

	cd $src-pam
	CC=gcc \
	./configure \
		--sysconfdir=/etc \
		--libdir=/usr/lib \
		--localstatedir=/var \
		--enable-pam \
		--disable-systemd \
		--with-rcdir=/tmp/cupsinit \
		--with-system-groups=lpadmin \
		--with-docdir=/usr/share/doc/cups-$VERSION \
		$CONFIGURE_ARGS &&
	make &&
	make BUILDROOT=$install-pam install || return 1

	for inst in $install $install-pam ; do
		rm -rf $inst/tmp &&

		ln -svnf ../doc/cups-$VERSION $inst/usr/share/cups/doc-$VERSION

		echo "ServerName /var/run/cups/cups.sock" > $inst/etc/cups/client.conf &&

		sed -i 's|hostname:9100|&\n\n    parallel:/dev/usb/lp0|' \
			$inst/usr/share/cups/templates/choose-uri.tmpl &&
		sed -i 's|htmlview|browser|' $inst/usr/share/applications/cups.desktop &&
		sed -i 's|^#Group .*|Group lp|' $inst/etc/cups/cups-files.conf &&

		# Daemon script
		cp -a $stuff/etc $inst &&
		chown -R root:root $inst/etc &&
		# TazPanel link
		cp -a $stuff/var $inst &&
		chown -R root:root $inst/var &&

		# Install ssl directory where to store the certs, solves some samba issues
		install -dm700 -g lp $inst/etc/cups/ssl &&

		# Install some more configuration files that will get filled by cupsd
		touch $inst/etc/cups/printers.conf &&
		touch $inst/etc/cups/classes.conf &&
		touch $inst/etc/cups/subscriptions.conf &&
		chgrp -R lp $inst/etc/cups &&

		# Comment out unnecessary PageLogFormat entry
		sed -i -e 's:PageLogFormat:#PageLogFormat:' $inst/etc/cups/cupsd.conf* &&

		# Change files permissions to be accessible via web interface - will be
		# fixed in post_install
		chmod -c o+r $inst/etc/cups/* $inst/usr/sbin/cupsd \
		$inst/usr/lib/cups/backend/ipp $inst/usr/lib/cups/backend/lpd
	done
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	case $PACKAGE in
		libcups)
			copy libcups.so*
			CAT="system-tools|common libraries"
			TAGS="printer printing"
			DEPENDS="libgnutls zlib"
			;;
		cups)
			copy @std @rm
			DEPENDS="acl dbus libcups libgnutls libusb zlib"
			CONFIG_FILES="/etc/cups/"
			TAGS="printer printing"
			;;
		cups-pam)
			install=$install-pam \
			copy @std
			rm -f $fs/usr/lib/libcups.so*
			CAT="system-tools|with PAM support"
			DEPENDS="acl dbus libcups libgnutls libusb zlib pam"
			PROVIDE="cups:pam"
			CONFIG_FILES="/etc/cups/"
			TAGS="printer printing"
			;;
		cups-doc)
			# We need the doc for CSS, images and help in the web interface.
			copy doc/
			CAT="docs|documentation"
			DEPENDS="cups"
			;;
		cups-dev)
			copy @dev
			;;
	esac
}

post_install_cups() {
	# Start CUPS daemon
	if [ -z "$1" -a ! -s /aufs-umount.sh ]; then
		/etc/init.d/cupsd start || continue
	fi

	# Clean TazPanel menu cache
	rm -f "$1"/var/cache/tazpanel/* 2>/dev/null

	# Edit daemons.conf
	if ! grep -q ^CUPSD_OPTIONS "$1/etc/daemons.conf"; then
		cat >> "$1/etc/daemons.conf" <<EOT
# CUPS printing daemon options.
CUPSD_OPTIONS=""

EOT
	fi

	# Add lpadmin group
	addgroup -g 23 lpadmin

	# Return permissions to previous state
	chmod 640 $1/etc/cups/*
	chmod 700 $1/usr/lib/cups/backend/ipp $1/usr/lib/cups/backend/lpd
	chmod 500 $1/usr/sbin/cupsd
}

pre_remove_cups() {
	# Stop CUPS daemon before rm.
	[ -z "$1" -a -x /etc/init.d/cupsd ] && /etc/init.d/cupsd stop
	:
}

post_install_cups_pam() {
	# Start CUPS daemon
	if [ -z "$1" -a ! -s /aufs-umount.sh ]; then
		/etc/init.d/cupsd start || continue
	fi

	# Clean TazPanel menu cache
	rm -f "$1"/var/cache/tazpanel/* 2>/dev/null

	# Edit daemons.conf
	if ! grep -q ^CUPSD_OPTIONS "$1/etc/daemons.conf"; then
		cat >> "$1/etc/daemons.conf" <<EOT
# CUPS printing daemon options.
CUPSD_OPTIONS=""

EOT
	fi

	# Add lpadmin group
	addgroup -g 23 lpadmin

	# Return permissions to previous state
	chmod 640 $1/etc/cups/*
	chmod 700 $1/usr/lib/cups/backend/ipp $1/usr/lib/cups/backend/lpd
	chmod 500 $1/usr/sbin/cupsd
}

pre_remove_cups_pam() {
	# Stop CUPS daemon before rm.
	[ -z "$1" -a -x /etc/init.d/cupsd ] && /etc/init.d/cupsd stop
	:
}
