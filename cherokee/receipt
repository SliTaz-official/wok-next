# SliTaz package receipt v2.

PACKAGE="cherokee"
VERSION="1.2.101"
CATEGORY="network"
SHORT_DESC="A very fast, fiexible and easy to configure Web Server."
MAINTAINER="slaxemulator@gmail.com"
LICENSE="GPL2"
WEB_SITE="http://www.cherokee-project.com/"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="http://www.cherokee-project.com/download/${VERSION%.*}/$VERSION/$TARBALL"

BUILD_DEPENDS="pcre-dev cyrus-sasl-dev openssl-dev openldap-dev python-dev \
pam-dev libmysqlclient ffmpeg-dev gettext autoconf automake"
SPLIT="cherokee cherokee-dev cherokee-doc"

compile_rules() {
	# Update deprecated symbols of ffmpeg
	sed -i 's|hdl->avformat->file_size|avio_size(hdl->avformat)|' cherokee/handler_streaming.c

	# Use subdirectory for logs
	sed -i -r 's|(%localstatedir%/log)|\1/cherokee|' cherokee.conf.sample.pre

	autoreconf -v
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--with-wwwroot=/var/www/cherokee \
		--disable-static \
		--with-wwwuser=www \
		--with-wwwgroup=www \
		--enable-os-string="SliTaz" \
		$CONFIGURE_ARGS &&
	make &&
	make DESTDIR=$DESTDIR install || return 1

	install -Dm644 pam.d_cherokee $install/etc/pam.d/cherokee
	chown -R www:www $install/var/lib/cherokee/graphs
	python    -m compileall $install
	python -O -m compileall $install

	install -d -o80 -u80 $install/var/log/cherokee

	install -Dm644 $stuff/cherokee.logrotate $install/etc/logrotate.d/cherokee
	install -Dm755 $stuff/cherokee           $install/etc/init.d/cherokee
}

genpkg_rules() {
	case $PACKAGE in
		cherokee)
			copy @std
			DEPENDS="pcre cyrus-sasl openssl python libmysqlclient \
			libldap ffmpeg"
			PROVIDE="lighttpd"
			;;
		cherokee-dev)
			copy @dev
			;;
		cherokee-doc)
			copy doc/
			CAT="misc|documentation"
			DEPENDS="cherokee"
			;;
	esac
}
