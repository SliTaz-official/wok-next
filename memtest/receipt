# SliTaz package receipt v2.

PACKAGE="memtest"
VERSION="5.01"
CATEGORY="base-system"
SHORT_DESC="Memory failures detection tool."
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="GPL2"
WEB_SITE="http://www.memtest.org/"

SOURCE="memtest86+"
TARBALL="$SOURCE-$VERSION.tar.gz"
WGET_URL="${WEB_SITE}download/$VERSION/$TARBALL"

BUILD_DEPENDS="xz"
SPLIT="memtest-serial gcc3"

# Rules to configure and make the package.
compile_rules()
{
	sed -i  -e '/scp memtest.bin/d' -e 's/gcc/gcc-3/' \
		-e 's/-fno-stack-protector//' Makefile
	sed -i 's/0b10/2/' init.c
	patch -p1 < $stuff/$SOURCE-$VERSION-array-size.patch
	make
	cp $stuff/*.S $stuff/pack .
	for i in bootloader unpack ; do
		cc -o $i.o -Wa,-a=$i.lst -c $i.S
		objcopy -O binary $i.o $i.bin
	done
	sed -i "s/VERSION/$VERSION/" pack
	./pack --build bootloader.bin unpack.bin
	./pack memtest.bin memtest.packed
	mv memtest.bin memtest.bin.console
	sed -i  -e 's/SERIAL_CONSOLE_DEFAULT 0/SERIAL_CONSOLE_DEFAULT 1/' \
		-e 's/SERIAL_BAUD_RATE 9600/SERIAL_BAUD_RATE 115200/' config.h
	make clean
	make
	./pack memtest.bin memtest.packed-115200
	mv memtest.bin memtest.bin.serial
} 


# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	case $PACKAGE in
	memtest)
		mkdir -p $fs/boot
		cp $src/memtest.packed $fs/boot/memtest
		;;
	memtest-serial)
		CAT="base-system|Memory failures detection tool using serial port."
		mkdir -p $fs/boot
		cp $src/memtest.packed-115200 $fs/boot/memtest
		;;
	esac
}

# Pre and post install commands for Tazpkg.
post_install_memtest_serial()
{
	cat <<EOT
Output to vga and serial port. Default kernel cmdline: console=ttyS0,115200e8
EOT
}
