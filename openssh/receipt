# SliTaz package receipt v2.

PACKAGE="openssh"
VERSION="7.5p1"
CATEGORY="security"
SHORT_DESC="OpenSSH clients and daemon"
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="BSD"
WEB_SITE="https://www.openssh.com/"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="http://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/$TARBALL"

BUILD_DEPENDS="libcrypto-dev zlib-dev openssl-dev perl mdocml-dev pam-dev" # groff
SPLIT="sftp-server openssh openssh-pam"

# Rules to configure and make the package.
compile_rules()
{
	# http://www.linuxfromscratch.org/blfs/view/stable/postlfs/openssh.html
	install  -v -m700 -d /var/lib/sshd &&
	chown    -v root:sys /var/lib/sshd &&

	addgroup -g 50 -S sshd &&
	adduser \
		-h /var/lib/sshd \
		-g 'sshd PrivSep' \
		-s /bin/false \
		-G sshd \
		-S -D \
		-u 50 \
		sshd &&

	cp -a $src $src-pam
	./configure \
		--sysconfdir=/etc/ssh \
		--with-md5-passwords \
		--with-privsep-path=/var/lib/sshd \
		--without-pam \
		--without-ssh1 \
		$CONFIGURE_ARGS &&
	make && make DESTDIR=$DESTDIR install || return 1

	cd $src-pam
	./configure \
		--sysconfdir=/etc/ssh \
		--with-privsep-path=/var/lib/sshd \
		--with-pam \
		--with-xauth=/usr/bin/xauth \
		--without-ssh1 \
		$CONFIGURE_ARGS &&
	make && make DESTDIR=$DESTDIR-pam install || return 1

	for inst in $install $install-pam ; do
		install -vm755 contrib/ssh-copy-id $inst/usr/bin

		install=$inst cook_pick_manpages contrib/ssh-copy-id.1
		install=$inst cook_pick_docs INSTALL LICENCE OVERVIEW README*

		# SliTaz stuff

		mkdir -p $inst/etc/init.d
		cp $stuff/openssh $inst/etc/init.d
		cat >> $inst/etc/ssh/ssh_config <<EOT

# client bug CVE-2016-0777 and CVE-2016-0778
Host *
  UseRoaming no

# From https://wiki.gentoo.org/wiki/SSH_jump_host
Host *+*
  ProxyCommand ssh $(echo %h | sed 's/+[^+]*$//;s/\([^+%%]*\)%%\([^+]*\)$/\2 -l \1/;s/:/ -p /') exec nc -w1 $(echo %h | sed 's/^.*+//;/:/!s/$/ %p/;s/:/ /')

EOT
	done
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	case $PACKAGE in
		sftp-server)
			copy sftp-server
			CAT="security|secure FTP server"
			TAGS="ssh"
			DEPENDS="libcrypto zlib"
			;;
		openssh)
			copy @std sshd/
			DEPENDS="sftp-server libcrypto zlib"
			CONFIG_FILES="/etc/ssh/moduli /etc/ssh/ssh_config /etc/ssh/sshd_config \
			/etc/inetd.conf"
			TAGS="ssh security"
			PROVIDE="ssh"
			TAZPANEL_DAEMON="man::sshd|edit::/etc/ssh/sshd_config|options|web::$WEB_SITE"
			;;
		openssh-pam)
			install=$install-pam copy @std sshd/
			sed -i 's/.*UsePAM.*/UsePAM yes/' $fs/etc/ssh/sshd_config
			DEPENDS="sftp-server libcrypto zlib pam"
			CONFIG_FILES="/etc/ssh/moduli /etc/ssh/ssh_config /etc/ssh/sshd_config \
			/etc/inetd.conf"
			TAGS="ssh security"
			PROVIDE="openssh:pam ssh:pam"
			TAZPANEL_DAEMON="man::sshd|edit::/etc/ssh/sshd_config|options|web::$WEB_SITE"
			;;
	esac
}

post_install_openssh() {
	grep -q ssh "$1/etc/inetd.conf" || cat >> "$1/etc/inetd.conf" <<EOT
#ssh	stream	tcp	nowait	root	sshd	sshd	-i
EOT

	while read dropbear openssh; do
		[ -s "$1$dropbear" ] || continue
		chroot "$1/" dropbearconvert dropbear openssh $dropbear $openssh
		chroot "$1/" dropbearkey -y -f $dropbear | grep ssh > "$1$openssh.pub"
		chroot "$1/" dropbearkey -y -f $dropbear | grep Fingerprint
	done <<EOT
/etc/dropbear/dropbear_rsa_host_key	/etc/ssh/ssh_host_rsa_key
/etc/dropbear/dropbear_dss_host_key	/etc/ssh/ssh_host_dsa_key
/etc/dropbear/dropbear_ecdsa_host_key	/etc/ssh/ssh_host_ecdsa_key
EOT

	chroot "$1/" ssh-keygen -A
}

post_remove_openssh() {
	grep -q sshd "$1/etc/inetd.conf" &&
	sed -i '/sshd/d' "$1/etc/inetd.conf"
}

post_install_openssh_pam() {
	grep -q ssh "$1/etc/inetd.conf" || cat >> "$1/etc/inetd.conf" <<EOT
#ssh	stream	tcp	nowait	root	sshd	sshd	-i
EOT

	while read dropbear openssh; do
		[ -s "$1$dropbear" ] || continue
		chroot "$1/" dropbearconvert dropbear openssh $dropbear $openssh
		chroot "$1/" dropbearkey -y -f $dropbear | grep ssh > "$1$openssh.pub"
		chroot "$1/" dropbearkey -y -f $dropbear | grep Fingerprint
	done <<EOT
/etc/dropbear/dropbear_rsa_host_key	/etc/ssh/ssh_host_rsa_key
/etc/dropbear/dropbear_dss_host_key	/etc/ssh/ssh_host_dsa_key
/etc/dropbear/dropbear_ecdsa_host_key	/etc/ssh/ssh_host_ecdsa_key
EOT

	chroot "$1/" ssh-keygen -A
}

post_remove_openssh_pam() {
	grep -q sshd "$1/etc/inetd.conf" &&
	sed -i '/sshd/d' "$1/etc/inetd.conf"
}
