# SliTaz package receipt v2.

PACKAGE="slim"
VERSION="1.3.5"
CATEGORY="x-window"
SHORT_DESC="Desktop-independent graphical login manager for X11"
MAINTAINER="pankso@slitaz.org"
LICENSE="GPL2"
WEB_SITE="https://sourceforge.net/projects/slim.berlios/"
HOST_ARCH="i486 arm"
COOKOPTS="!pngquant op8"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="$SF_MIRROR/slim.berlios/$TARBALL"

BUILD_DEPENDS_arm="freetype-dev jpeg-dev libpng-dev xorg-libXft-dev \
xorg-libXmu-dev"
BUILD_DEPENDS="cmake xorg-libX11-dev freetype-dev libjpeg-turbo-dev zlib-dev \
libpng16-dev fontconfig-dev xorg-libXft-dev xorg-libXrender-dev xorg-libXmu-dev"
SPLIT="slim-theme-default slim slim-pam"

# Rules to configure and make the package.
compile_rules()
{
	# Handle cross compilation
	case "$ARCH" in
		i?86)
			INCL=/usr/include
			LIBS=/usr/lib ;;
		arm*)
			INCL=/cross/$ARCH/sysroot/usr/include
			LIBS=/cross/$ARCH/sysroot/usr/lib ;;
	esac

	mkdir build; cd build
	cp -a $src $src-pam
	cmake \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DX11_Xmu_LIB="$LIBS/libXmu.so" \
		-DX11_Xft_INCLUDE_PATH=$INCL \
		-DX11_Xmu_INCLUDE_PATH=$INCL \
		-DUSE_PAM=no \
		.. &&
	make &&
	make DESTDIR=$DESTDIR install || exit 1

	cd $src-pam/build
	cmake \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DX11_Xmu_LIB="$LIBS/libXmu.so" \
		-DX11_Xft_INCLUDE_PATH=$INCL \
		-DX11_Xmu_INCLUDE_PATH=$INCL \
		-DUSE_PAM=yes \
		.. &&
	make &&
	make DESTDIR=$DESTDIR-pam install || exit 1

	for inst in $install $install-pam ; do
		cp -r $stuff/themes $inst/usr/share/slim

		# Config file and rc script.
		cp -a $stuff/etc $inst

		# slim-theme manager & default strings
		install -m755 $stuff/slim-theme $inst/usr/bin/slim-theme
		install -m644 $stuff/strings    $inst/usr/share/slim/strings

		chown -R root:root $inst
	done
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules() {
	case $PACKAGE in
		slim-theme-default)
			CAT="customization|default theme bundled with SLiM"
			copy default/
			DEPENDS="slim slitaz-configs-base"
			;;
		slim)
			copy @std
			remove_already_packed
			DEPENDS="fontconfig freetype libjpeg-turbo libpng16 xorg-libX11 \
			xorg-libXft xorg-libXmu xorg-libXrender zlib"
			CONFIG_FILES="/etc/slim.conf"
			SUGGESTED="slim-theme-default slitaz-configs"
			;;
		slim-pam)
			install=$install-pam copy @std
			rm -rf $fs/usr/share/slim/themes/default
			DEPENDS="fontconfig freetype libjpeg-turbo libpng16 xorg-libX11 \
			xorg-libXft xorg-libXmu xorg-libXrender zlib pam"
			CONFIG_FILES="/etc/slim.conf"
			SUGGESTED="slim-theme-default slitaz-configs"
			PROVIDE="slim:pam"
			CAT="x-window|(PAM enabled)"
			;;
	esac
}

post_install_slim() {
	local USER=$(awk -F: '/:1000:1000:/ { print $1 }' "$1/etc/passwd")
	[ -n "$USER" ] &&
	sed -i s/"default_user .*"/"default_user        $USER"/ "$1/etc/slim.conf"
	sed -i 's|>/tmp/X-output||' "$1/etc/slim.conf"
}

post_install_slim_pam() {
	local USER=$(awk -F: '/:1000:1000:/ { print $1 }' "$1/etc/passwd")
	[ -n "$USER" ] &&
	sed -i s/"default_user .*"/"default_user        $USER"/ "$1/etc/slim.conf"
	sed -i 's|>/tmp/X-output||' "$1/etc/slim.conf"
}

post_install_slim_theme_default() {
	chroot "$1/" slim-theme -sdefault
}

pre_remove_slim_theme_default() {
	chroot "$1/" slim-theme -fdefault
}
