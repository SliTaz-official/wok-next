# SliTaz package receipt.

PACKAGE="qemu-light"
VERSION="2.0.2"
CATEGORY="misc"
SHORT_DESC="Light Qemu i386-softmmu target (without xen, vde, bluez, blobs, tls)."
MAINTAINER="pankso@slitaz.org"
LICENSE="GPL2"
SOURCE="qemu"
TARBALL="$SOURCE-$VERSION.tar.bz2"
WEB_SITE="http://www.qemu.org/"
WGET_URL="http://wiki.qemu.org/download/$TARBALL"
TAGS="virtualization"
CONFLICT="qemu"

DEPENDS="alsa-lib libsdl util-linux-uuid"
BUILD_DEPENDS="gettext perl alsa-lib-dev libsdl-dev util-linux-uuid-dev python \
glib-dev zlib-dev autoconf automake libtool bison flex"

# Rules to configure and make the package.
compile_rules()
{
	mkdir -p $DESTIDR/usr/share/qemu/ia32

	[ -s $SRC/$UEFIZIP ] || wget -P $SRC \
		http://netassist.dl.sourceforge.net/project/edk2/OVMF/$UEFIZIP
	unzip $SRC/$UEFIZIP OVMF.fd -d $DESTIDR/usr/share/qemu/ia32

	patch -p0 < $stuff/cloop.u

	TARGET="i386-softmmu"

	export LDFLAGS="$LDFLAGS -Wl,--copy-dt-needed-entries"
	#--cross-prefix= --host-cc=
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--disable-xen \
		--disable-vnc-sasl \
		--disable-vnc-tls \
		--disable-curl \
		--disable-bluez \
		--disable-curses \
		--disable-vde \
		--audio-drv-list=alsa \
		--target-list="$TARGET" \
		--cc=$BUILD_SYSTEM-gcc &&
	make && make DESTDIR=$DESTDIR install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	mkdir -p $fs/usr/share/qemu
	cp -a $install/usr/bin $fs/usr
	cp -a $install/usr/share/qemu/keymaps $fs/usr/share/qemu
	for bin in bios.bin vgabios-cirrus.bin pxe-e1000.rom linuxboot.bin
	do
		cp -a $install/usr/share/qemu/$bin $fs/usr/share/qemu
	done
	# Create qemu symlink
	cd $fs/usr/bin && ln -s qemu-system-i386 qemu
}
