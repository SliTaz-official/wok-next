# SliTaz package receipt v2.

PACKAGE="mupdf"
VERSION="1.11"
CATEGORY="utilities"
SHORT_DESC="A lightweight PDF and XPS viewer"
MAINTAINER="jozee@slitaz.org"
LICENSE="GPL3"
WEB_SITE="http://mupdf.com/"

TARBALL="$PACKAGE-$VERSION-source.tar.gz"
WGET_URL="http://mupdf.com/downloads/$TARBALL"

BUILD_DEPENDS="freetype-dev fontconfig-dev jbig2dec-dev libjpeg-turbo-dev \
openjpeg-dev zlib-dev xorg-dev"
SPLIT="mudraw mupdf mupdf-dev"

compile_rules() {
	# Use system wide libraries instead of included ones
	rm -rf $src/thirdparty

	case "$ARCH" in
		arm*)
			ARCH_ARGS='OS="slitaz-arm"'
			unset CC CFLAGS
			make generate
			cat >> Makerules <<EOT
ifeq "\$(OS)" "slitaz-arm"
SYS_FREETYPE_INC = -I/cross/$ARCH/sysroot/usr/include
CC = ${HOST_SYSTEM}-gcc
LD = ${HOST_SYSTEM}-ld
AR = ${HOST_SYSTEM}-ar
CFLAGS += -I/cross/$ARCH/sysroot/usr/include -O2 -march=armv6 -ftree-vectorize -ffast-math -fsingle-precision-constant
CROSSCOMPILE=yes
endif
EOT
			ln -s /usr/include/freetype2/freetype/ /usr/include/freetype
			;;
	esac
	make ${ARCH_ARGS} build=release &&
	make ${ARCH_ARGS} build=release prefix=/usr install
	rm -rf /usr/include/freetype
}

genpkg_rules() {
	case $PACKAGE in
		mudraw)
			copy mudraw
			CAT="development|mudraw"
			DEPENDS="bzlib freetype jbig2dec openjpeg"
			;;
		mupdf)
			copy @std @rm
			DEPENDS="bzlib freetype fontconfig jbig2dec openjpeg xorg-libXext"
			;;
		mupdf-dev)
			copy @dev
			;;
	esac
}
