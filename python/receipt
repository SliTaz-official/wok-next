# SliTaz package receipt v2.

PACKAGE="python"
VERSION="2.7.15"
CATEGORY="development"
SHORT_DESC="The Python programming language"
MAINTAINER="pankso@slitaz.org"
LICENSE="PSL"
WEB_SITE="https://www.python.org/"
LFS="http://www.linuxfromscratch.org/blfs/view/stable/general/python2.html"
REPOLOGY="python2"

TARBALL="$PACKAGE-$VERSION.tar.xz"
WGET_URL="https://www.python.org/ftp/python/$VERSION/Python-$VERSION.tar.xz"

BUILD_DEPENDS="openssl-dev bzip2-dev readline-dev sqlite3-dev zlib-dev \
ncurses-dev tcl-dev tk-dev db-dev gdbm-dev libffi-dev expat-dev"
SPLIT="python-dev python-idle python-tcltk python"
COOKOPTS="!menus !zip"

compile_rules() {
	# Temporary workaround for FS#22322
	# See http://bugs.python.org/issue10835 for upstream report
	sed -i.orig "/progname =/s/python/python${_pybasever}/" Python/pythonrun.c

	# Enable built-in SQLite3 module to load extensions (fix FS#22122)
	sed -i.orig "/SQLITE_OMIT_LOAD_EXTENSION/d" setup.py

	case "$ARCH" in
		arm*)
			# First pass for build host tools
			unset CFLAGS CXXFLAGS
			cp -f $CONFIG_SITE .
			CONFIG_SITE="$(pwd)/cook.site"
			cat >> $CONFIG_SITE <<EOT
ac_cv_have_long_long_format=yes
EOT
			./configure CC=gcc \
				--disable-ipv6 \
				--build=i486-slitaz-linux \
				--host=${BUILD_SYSTEM} &&
			make python Parser/pgen &&
			mv python hostpython &&
			mv Parser/pgen Parser/hostpgen || exit 1
			make distclean
			rm -f $CONFIG_SITE
			# Second pass for host tools
			. /etc/slitaz/cook.conf
			cp -f $CONFIG_SITE .
			CONFIG_SITE="$(pwd)/cook.site"
			cat >> $CONFIG_SITE <<EOT
ac_cv_have_long_long_format=yes
ac_cv_buggy_getaddrinfo=no
ac_cv_file__dev_ptmx=yes
ac_cv_file__dev_ptc=no
EOT
			./configure CC=${HOST_SYSTEM}-gcc \
				--disable-ipv6 \
				--enable-shared \
				--with-system-ffi \
				${CONFIGURE_ARGS} &&
			make \
				PYTHON_FOR_BUILD=${src}/hostpython \
				HOSTPYTHON=${src}/hostpython \
				HOSTPGEN=${src}/Parser/hostpgen \
				CROSS_COMPILE_TARGET=yes \
				HOSTARCH=${HOST_SYSTEM} \
				BUILDARCH=${BUILD_SYSTEM} || exit 1
			make DESTDIR=$DESTDIR install || exit 1
			;;
		i?86|x86_64)
			./configure \
				--prefix=/usr \
				--enable-shared \
				--with-system-expat \
				--with-system-ffi \
				--without-ensurepip \
				--enable-unicode=ucs4 \
				$CONFIGURE_ARGS &&
				make &&
				make DESTDIR=$DESTDIR install &&
				chmod -v 755 $install/usr/lib/libpython2.7.so.1.0
			;;
	esac

	find $install -type f \( -name '*.pyc' -o -name '*.pyo' \) -delete
}

genpkg_rules() {
	case $PACKAGE in
		*-dev)
			copy @dev test/ distutils/command/*.exe ensurepip/
			find $fs -type f -name pyconfig.h -delete # move to python package
			;;
		*-idle)
			copy idle idlelib/ python-idle.desktop
			CAT="development|GUI IDE using TK Toolkit"
			DEPENDS="python-tcltk tcl tk"
			;;
		*-tcltk)
			copy _tkinter.so lib-tk/ @rm
			CAT="development|Tcl/Tk files"
			DEPENDS="python tcl tk xorg-libX11"
			;;
		python)
			# Now pyconfig.h is required for Mercurial.
			copy @std @rm pyconfig.h
			DEPENDS="python-setuptools python-pip \
			bzlib expat gdbm libffi libsqlite3 ncurses \
			ncurses-libpanel openssl readline zlib"
			;;
	esac
}
