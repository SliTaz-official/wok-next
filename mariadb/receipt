# SliTaz package receipt v2.

PACKAGE="mariadb"
VERSION="10.2.18"
CATEGORY="office"
SHORT_DESC="SQL database system"
MAINTAINER="devel@slitaz.org"
LICENSE="GPL2"
WEB_SITE="https://mariadb.org/"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="https://downloads.mariadb.org/interstitial/mariadb-$VERSION/source/$TARBALL"

BUILD_DEPENDS="cmake ncurses-dev bison openssl-dev"
BUILD_DEPENDS="cmake libaio-dev valgrind-dev zlib-dev openssl-dev ncurses-dev \
pcre-dev curl-dev libxml2-dev xz-dev "
SPLIT="libmariadbclient $PACKAGE-client $PACKAGE-dev $PACKAGE-test"

compile_rules() {
	case $ARCH in
		i?86) ARCH_ARGS='-DPLUGIN_ROCKSDB=NO';;
		*)    ARCH_ARGS='-DPLUGIN_ROCKSDB=YES';;
	esac

	cmake \
		-DBUILD_CONFIG=mysql_release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DSYSCONFDIR=/etc \
		-DSYSCONF2DIR=/etc/my.cnf.d \
		-DMYSQL_DATADIR=/var/lib/mysql \
		-DMYSQL_UNIX_ADDR=/run/mysqld/mysqld.sock \
		-DDEFAULT_CHARSET=utf8 \
		-DDEFAULT_COLLATION=utf8_general_ci \
		-DENABLED_LOCAL_INFILE=ON \
		-DINSTALL_INFODIR=share/info \
		-DINSTALL_MANDIR=share/man \
		-DINSTALL_PLUGINDIR=lib/mariadb/plugin \
		-DINSTALL_SCRIPTDIR=bin \
		-DINSTALL_INCLUDEDIR=include/mysql \
		-DINSTALL_DOCREADMEDIR=share/doc/mariadb \
		-DINSTALL_SUPPORTFILESDIR=share/mariadb \
		-DINSTALL_MYSQLSHAREDIR=share/mariadb \
		-DINSTALL_DOCDIR=share/doc/mariadb \
		-DTMPDIR=/var/tmp \
		-DCONNECT_WITH_MYSQL=ON \
		-DCONNECT_WITH_LIBXML2=system \
		-DCONNECT_WITH_ODBC=NO \
		-DCONNECT_WITH_JDBC=NO \
		-DPLUGIN_ARCHIVE=YES \
		-DPLUGIN_ARIA=YES \
		-DPLUGIN_BLACKHOLE=YES \
		-DPLUGIN_CASSANDRA=NO \
		-DPLUGIN_CSV=YES \
		-DPLUGIN_MYISAM=YES \
		-DPLUGIN_MROONGA=NO \
		-DPLUGIN_OQGRAPH=NO \
		-DPLUGIN_PARTITION=YES \
		-DPLUGIN_SPHINX=NO \
		-DPLUGIN_TOKUDB=NO \
		-DPLUGIN_AUTH_PAM=NO \
		-DPLUGIN_AUTH_GSSAPI=NO \
		-DPLUGIN_AUTH_GSSAPI_CLIENT=OFF \
		-DPLUGIN_CRACKLIB_PASSWORD_CHECK=NO \
		-DWITH_ASAN=OFF \
		-DWITH_EMBEDDED_SERVER=ON \
		-DWITH_EXTRA_CHARSETS=complex \
		-DWITH_INNODB_BZIP2=OFF \
		-DWITH_INNODB_LZ4=OFF \
		-DWITH_INNODB_LZMA=ON \
		-DWITH_INNODB_LZO=OFF \
		-DWITH_INNODB_SNAPPY=OFF \
		-DWITH_ROCKSDB_BZIP2=OFF \
		-DWITH_ROCKSDB_JEMALLOC=OFF \
		-DWITH_ROCKSDB_LZ4=OFF \
		-DWITH_ROCKSDB_ZSTD=OFF \
		-DWITH_ROCKSDB_SNAPPY=OFF \
		-DWITH_JEMALLOC=NO \
		-DWITH_LIBARCHIVE=system \
		-DWITH_LIBNUMA=NO \
		-DWITH_LIBWRAP=OFF \
		-DWITH_LIBWSEP=OFF \
		-DWITH_MARIABACKUP=ON \
		-DWITH_PCRE=system \
		-DWITH_READLINE=ON \
		-DWITH_SYSTEMD=no \
		-DWITH_SSL=system \
		-DWITH_VALGRIND=OFF \
		-DWITH_ZLIB=system \
		-DSKIP_TESTS=ON \
		$ARCH_ARGS \
		. &&
	# print config options to log
	cmake -L &&
	make &&
	make install
}

genpkg_rules() {
	case $PACKAGE in
		mariadb)
			CONFIG_FILES="/etc/mysql"
			TAZPANEL_DAEMON="man|edit::/etc/mysql/my.cnf|options|web::$WEB_SITE"
			PROVIDE="mysql"
			CONFIG_FILES="/etc/mysql/my.cnf"
			DATABASE_FILES="/var/lib/mysql"
			DEPENDS="busybox libmariadbclient mariadb-client zlib \
			slitaz-base-files gcc-lib-base"
			mkdir -p \
				$fs/usr/share \
				$fs/usr/lib/mysql/plugin \
				$fs/etc/mysql \
				$fs/etc/mysql.d \
				$fs/var/lib/mysql

			cp -a $install/usr/bin $fs/usr
			cp -a $install/usr/scripts/* $fs/usr/bin
			cp -a $install/usr/lib/mysql/plugin/*.so* $fs/usr/lib/mysql/plugin
			cp -a $install/usr/share/mysql $fs/usr/share

			# Configuration file
			cp -a $stuff/etc/init.d $fs/etc
			cp -a $src/support-files/my-medium.cnf $fs/etc/mysql/my.cnf
			cp -a $src/support-files/my-small.cnf $fs/etc/mysql
			grep -q "bind-address" $fs/etc/mysql/my.cnf || sed -i \
				's/^\[mysqld\]/[mysqld]\nbind-address\t= 127.0.0.1/' \
				$fs/etc/mysql/my.cnf

			# Permissions
			chmod 600 $fs/etc/mysql/my.cnf

			cat $stuff/*.files-list | while read file; do
				[ -f $fs$file ] && rm -f $fs$file
			done
			;;
		libmariadbclient)
			CAT="misc|client libraries"
			PROVIDE="libmysqlclient"
			DEPENDS="zlib openssl"
			mkdir -p $fs/usr/lib/mysql
			cp -a $install/usr/lib/mysql/libmysqlclient*so* $fs/usr/lib/mysql
			cd $fs/usr/lib
			ln -s mysql/libmysqlclient.so .
			ln -s mysql/libmysqlclient.so.18 .
			ln -s mysql/libmysqlclient.so.18.0.0 .
			ln -s mysql/libmysqlclient_r.so .
			ln -s mysql/libmysqlclient_r.so.18 .
			ln -s mysql/libmysqlclient_r.so.18.0.0 .
			;;
		mariadb-client)
			CAT="office|client files"
			PROVIDE="mysql_or_postgresql mysql-client"
			DEPENDS="libmariadbclient zlib ncurses gcc-lib-base ncurses"
			while read file; do
				dir=$(dirname $file)
				[ -d $fs$dir ] || mkdir -p $fs$dir
				cp -a $install$file $fs$file
			done < $wanted_stuff/$PACKAGE.files-list
			;;
		mariadb-dev)
			PROVIDE="mysql-dev"
			DEPENDS="zlib"
			mkdir -p $fs/usr/lib/mysql/plugin $fs/usr/share
			cp -a $install/usr/include $fs/usr
			cp -a $install/usr/share/aclocal $fs/usr/share
			cp -a $install/usr/lib/mysql/*.*a $fs/usr/lib/mysql
			#~ cp -a $install/usr/lib/mysql/plugin/*.*a $fs/usr/lib/mysql/plugin
			while read file; do
				dir=$(dirname $file)
				[ -d $fs$dir ] || mkdir -p $fs$dir
				cp -a $install$file $fs$file
			done < $wanted_stuff/$PACKAGE.files-list
			;;
		mariadb-test)
			CAT="misc|tests and benchs"
			DEPENDS="mariadb perl openssl"
			mkdir -p $fs/usr/share
			cp -a $install/usr/mysql-test $fs/usr
			cp -a $install/usr/sql-bench $fs/usr
			find $fs/usr/mysql-test $fs/usr/sql-bench -type d -exec chmod 2777 {} \;
			while read file; do
				dir=$(dirname $file)
				[ -d $fs$dir ] || mkdir -p $fs$dir
				cp -a $install$file $fs$file
			done < $wanted_stuff/$PACKAGE.files-list
			mv $fs/usr/mysql-test $fs/usr/share/mysql-test
			mv $fs/usr/sql-bench $fs/usr/share/sql-bench
			;;
	esac
}

post_install_mariadb() {
	local user
	local group

	user=mysql
	group=mysql

	if ! grep -q $user "$1/etc/passwd"; then
		chroot "$1/" addgroup -S $group
		chroot "$1/" adduser -s /bin/false -S -D -H -G $group $user
	fi

	[ -s "$quiet" ] || cat <<EOF

	.------------------------------------------------.
	| To start mariadb server you can run:           |
	|                                                |
	|    /etc/init.d/mariadb start                   |
	|                                                |
	| or add mariadb to RUN_DAEMONS in /etc/rcS.conf |
	'------------------------------------------------'
EOF
}

pre_install_mariadb() {
	# Cleanup old files
	rm -f "$1/usr/libexec/mysql"*
	# Mv config
	[ -f "$1/etc/my.cnf" ] && mv -f "$1/etc/my.cnf" "$1/etc/mysql/my.cnf"
}

post_remove_mariadb() {
	deluser mysql
}
