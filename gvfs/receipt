# SliTaz package receipt v2.

PACKAGE="gvfs"
VERSION="1.36.2"
CATEGORY="system-tools"
SHORT_DESC="Userspace virtual filesystem"
MAINTAINER="pankso@slitaz.org"
LICENSE="GPL2"
WEB_SITE="https://wiki.gnome.org/Projects/gvfs"
LFS="http://www.linuxfromscratch.org/blfs/view/svn/gnome/gvfs.html"

TARBALL="$PACKAGE-$VERSION.tar.xz"
WGET_URL="$GNOME_MIRROR/gvfs/${VERSION%.*}/$TARBALL"

BUILD_DEPENDS="meson ninja shared-mime-info libxslt glib-dev gtk-doc dbus-dev \
gcr-dev gettext polkit-dev libcap-dev libgphoto2-dev libarchive-dev \
libsoup-dev libcdio-paranoia-dev libmtp-dev fuse2-dev udisks2-dev gtk+3-dev \
libbluray-dev libgudev-dev libsecret-dev libxml2-dev openssh samba-dev \
dbus-glib-dev libnfs-dev libgdata-dev gnome-online-accounts-dev"
SPLIT="gvfs-admin gvfs-afp gvfs-archive gvfs-cdda gvfs-fuse gvfs-goa \
gvfs-google gvfs-gphoto2 gvfs-gtk gvfs-http gvfs-libmtp gvfs-nfs gvfs-smb \
gvfs-udisks2 gvfs gvfs-dev"
COOKOPTS="skip-log-errors"

# while webkit2gtk is broken on x86_64...
case $ARCH in
	x86_64)
		BUILD_DEPENDS="$(echo $BUILD_DEPENDS | sed 's|libgdata-dev||; s|gnome-online-accounts-dev||')"
		SPLIT="$(echo $SPLIT | sed 's|gvfs-goa||; s|gvfs-google||')"
		;;
esac

compile_rules() {
	sed -i 's|dependendencies|dependencies|' meson.build # typo

	# while webkit2gtk is broken on x86_64...
	case $ARCH in
		i?86)   ARCH_ARGS='-Dgoa=true  -Dgoogle=true';;
		x86_64) ARCH_ARGS='-Dgoa=false -Dgoogle=false';;
	esac

	meson-wrapper \
		build \
		-Dsystemduserunitdir=no \
		-Dtmpfilesdir=no \
		\
		-Dadmin=true \
		-Dafc=false \
		-Dafp=true \
		-Darchive=true \
		-Dcdda=true \
		-Ddnssd=false \
		-Dgdu=false \
		$ARCH_ARGS \
		-Dgphoto2=true \
		-Dhttp=true \
		-Dmtp=true \
		-Dnfs=true \
		-Dsmb=true \
		-Dudisks2=true \
		\
		-Dbluray=true \
		-Dfuse=true \
		-Dgcr=true \
		-Dgcrypt=true \
		-Dgudev=true \
		-Dkeyring=true \
		-Dlogind=false \
		-Dlibusb=true \
		\
		-Ddeprecated_programs=true \
		-Dman=true \
		&&
	ninja -j1 -C build &&
	ninja -j1 -C build install
}

genpkg_rules() {
	# gvfs-obexftp is called obsolete and deleted by gvfs authors.
	case $PACKAGE in
		gvfs-admin)
			copy gvfsd-admin admin.mount
			CAT="system-tools|admin backend"
			DEPENDS="glib gvfs polkit"
			;;
		gvfs-afp)
			copy \
			gvfsd-afp        afp.mount \
			gvfsd-afp-browse afp-browse.mount
			CAT="system-tools|Apple Filing Protocol support - afp:///"
			DEPENDS="glib gvfs libgcrypt"
			;;
		gvfs-archive)
			copy gvfsd-archive archive.mount
			CAT="system-tools|archive support - archive:///"
			DEPENDS="glib gvfs libarchive"
			;;
		gvfs-cdda)
			copy gvfsd-cdda cdda.mount
			CAT="system-tools|CDDA support"
			DEPENDS="glib gvfs libcdio libcdio-paranoia libgudev"
			;;
		gvfs-fuse)
			copy gvfsd-fuse
			CAT="system-tools|FUSE support"
			DEPENDS="fuse2 glib gvfs"
			;;
		gvfs-goa)
			copy gvfs-goa-volume-monitor *.GoaVolumeMonitor.service \
			goa.monitor
			CAT="system-tools|GOA support"
			DEPENDS="glib gnome-online-accounts   gvfs"
			;;
		gvfs-google)
			copy gvfsd-google google.mount
			CAT="system-tools|Google support"
			DEPENDS="glib gnome-online-accounts gvfs libgdata"
			;;
		gvfs-gphoto2)
			copy \
			gvfsd-gphoto2 gphoto2.mount \
			gvfs-gphoto2-volume-monitor *.GPhoto2VolumeMonitor.service \
			gphoto2.monitor
			CAT="system-tools|Gphoto2 support"
			DEPENDS="glib gvfs libgphoto2 libgudev"
			;;
		gvfs-gtk)
			copy gvfsd-recent recent.mount
			CAT="system-tools|recent files support (GTK+3) - recent:///"
			DEPENDS="glib gvfs" # + gtk+3 ?
			;;
		gvfs-http)
			copy \
			gvfsd-dav  dav.mount \
			gvfsd-http http.mount
			CAT="system-tools|HTTP/WebDAV support"
			DEPENDS="glib gvfs libsoup libxml2"
			;;
		gvfs-libmtp)
			copy \
			gvfsd-mtp mtp.mount \
			gvfs-mtp-volume-monitor *.MTPVolumeMonitor.service \
			mtp.monitor
			CAT="system-tools|MTP support"
			DEPENDS="glib gvfs libgudev libmtp libusb"
			;;
		gvfs-nfs)
			copy gvfsd-nfs nfs.mount
			CAT="system-tools|NFS support - nfs:///"
			DEPENDS="glib gvfs libnfs"
			;;
		gvfs-smb)
			copy \
			gvfsd-smb        smb.mount \
			gvfsd-smb-browse smb-browse.mount \
			gvfs-smb.convert *.smb.gschema.xml
			CAT="system-tools|Samba support - smb:///"
			DEPENDS="glib gvfs samba"
			;;
		gvfs-udisks2)
			copy gvfs-udisks2-volume-monitor *.UDisks2VolumeMonitor.service \
			udisks2.monitor
			CAT="system-tools|Udisks2 volume monitor"
			DEPENDS="glib libbluray libgudev libsecret udisks2   gvfs"
			;;
		gvfs)
			copy @std @rm
			DEPENDS="gcr-base glib libgudev libsecret   dbus eudev"
			SUGGESTED="gvfs-afp gvfs-archive gvfs-cdda gvfs-fuse gvfs-gphoto2 \
			gvfs-http gvfs-libmtp gvfs-obexftp gvfs-smb gvfs-udisks2"
			;;
		*-dev)
			copy @dev
			;;
	esac
}

post_remove_gvfs() {
	chroot "$1/" /usr/bin/glib-compile-schemas /usr/share/glib-2.0/schemas
}
