# SliTaz package receipt v2.

PACKAGE="mesa"
VERSION="12.0.6"
CATEGORY="x-window"
SHORT_DESC="3D Graphics Library that is an open-source implementaton of OpenGL."
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="MIT"
WEB_SITE="https://www.mesa3d.org/"
SUGGESTED="nvidia"
PROVIDE="libgl"
CONFIG_FILES="/etc/drirc"

TARBALL="$PACKAGE-$VERSION.tar.xz"
WGET_URL="ftp://ftp.freedesktop.org/pub/mesa/$VERSION/$TARBALL"

BUILD_DEPENDS="autoconf automake libtool python libdrm-dev libgcrypt-dev \
eudev-dev xorg-glproto xorg-dri2proto xorg-dri3proto xorg-presentproto \
xorg-libxcb-dev xorg-libxshmfence-dev xorg-libX11-dev xorg-libXext-dev \
xorg-libXdamage-dev xorg-libXfixes-dev xorg-libXxf86vm-dev expat-dev \
elfutils-dev llvm-dev xorg-libpciaccess-dev"
SPLIT="mesa mesa-dev mesa-dri libegl-mesa"
# libGLU is included in the package libglu-mesa
# libGLw is included in the package libglw-mesa
# libEGL is included in the package libegl-mesa

# Rules to configure and make the package.
compile_rules()
{
#	patch -p1 -i $stuff/mesa-12.0.patch

	# "swr" driver is disabled due to compilation errors
	GLL_DRV="nouveau,r300,r600,radeonsi,svga,swrast" &&

	sed -i "/pthread-stubs/d" configure.ac &&
	sed -i "/seems to be moved/s/^/: #/" bin/ltmain.sh &&
	./autogen.sh CFLAGS='-O2' CXXFLAGS='-O2' \
		--sysconfdir=/etc \
		--enable-texture-float \
		--enable-gles1 \
		--enable-gles2 \
		--enable-osmesa \
		--enable-xa \
		--enable-gbm \
		--enable-glx-tls \
		--with-egl-platforms="drm,x11" \
		--with-gallium-drivers=$GLL_DRV &&

	unset GLL_DRV &&

	make && make install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	case $PACKAGE in
	mesa)
		DEPENDS="expat libdrm xorg-libXdamage xorg-libXxf86vm \
			xorg-libXt udev xorg-libxshmfence"
		copy etc/ libGL.so* libGLESv1_CM.so* libGLESv2.so* \
			libOSMesa.so* libgbm.so* libglapi.so* libxatracker.so*
		;;
	mesa-dev)
		CAT="development|3D Graphics Library dev files."
		DEPENDS="mesa mesa-dri mesa-libegl libdrm-dev \
			xorg-libXdamage-dev  xorg-libXxf86vm-dev \
			xorg-libXt-dev xorg-glproto xorg-dri2proto pkg-config"
		copy *.h *.la *.pc
		;;
	mesa-dri)
		CAT="x-window|Mesa DRI drivers."
		DEPENDS="elfutils expat libdrm libdrm-intel libdrm-nouveau \
			libdrm-radeon libgcrypt libgpg-error llvm-libs \
			xorg-libpciaccess zlib"
		copy *_dri.so
		mkdir -p $fs/etc/X11/xorg.conf.d
		cp $stuff/90-DRI.conf $fs/etc/X11/xorg.conf.d
		;;
	libegl-mesa)
		CAT="libs|OpenGL utility library"
		DEPENDS="mesa"
		PROVIDE="mesa-libegl"
		copy libEGL*
		;;
	esac
}
