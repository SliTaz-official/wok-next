# SliTaz package receipt.

PACKAGE="kbd"
VERSION="2.0.3"
CATEGORY="system-tools"
SHORT_DESC="Keyboard mapping definitions and tools"
MAINTAINER="pankso@slitaz.org"
LICENSE="GPL2"
WEB_SITE="http://kbd-project.org/"
TAGS="keyboard"
HOST_ARCH="i486 arm"

TARBALL="kbd-$VERSION.tar.xz"
WGET_URL="https://www.kernel.org/pub/linux/utils/kbd/$TARBALL"

DEPENDS="kbd-base"
BUILD_DEPENDS="check-dev bison flex gettext advancecomp"
SPLIT="kbd-base kbd-busybox"

# Handle cross compilation.
case "$ARCH" in
	arm) BUILD_DEPENDS="flex check-dev" ;;
esac

# Rules to configure and make the package.
compile_rules()
{
	patch -Np1 -i $stuff/kbd-2.0.3-backspace-1.patch
	sed -i 's/\(RESIZECONS_PROGS=\)yes/\1no/g' configure
	sed -i 's/resizecons.8 //' docs/man/man8/Makefile.in

	cp -a data/keymaps data/keymaps.orig
	# Shrink keymaps
	for i in $(find data/keymaps -type f); do
		sed -i 's|	| |g; s|  *| |g; s|^ ||; s| $||; /^#/d; /^!/d; /^$/d' $i
	done

	./configure \
		--datadir=/usr/share/kbd \
		--disable-vlock \
		$CONFIGURE_ARGS &&
	make && make install

	mv $install/usr/share/kbd/locale $install/usr/share

	mkdir -p $install/usr/share/doc/kbd-$VERSION
	cp -R docs/doc/* $install/usr/share/doc/kbd-$VERSION

	if [ -n "$(which advdef)" ]; then
		action 'Recompressing GZ files...'
		local size0=$(find $install/usr/share/kbd -name '*.gz' -exec ls -l \{\} \; | awk '{s+=$5}END{print s}')
		local time0=$(date +%s)
		find $install/usr/share/kbd -name '*.gz' -exec advdef -z4q \{\} \;
		local size1=$(find $install/usr/share/kbd -name '*.gz' -exec ls -l \{\} \; | awk '{s+=$5}END{print s}')
		local time1=$(date +%s)
		status
		comp_summary "$time0" "$time1" "$size0" "$size1"
	fi

	# Cook "kbd-base" before "kbd" packaging to properly work cook_split_rm()
	cook kbd-base >/dev/null 2>&1
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	cook_copy_folders bin kbd
	cook_split_rm kbd-base
}
