# SliTaz package receipt v2.

PACKAGE="libvalhalla"
VERSION="2.1.0"
CATEGORY="multimedia"
SHORT_DESC="A tiny media scanner API"
MAINTAINER="pankso@slitaz.org"
LICENSE="LGPL2.1"
WEB_SITE="http://libvalhalla.geexbox.org/"

TARBALL="$PACKAGE-$VERSION.tar.bz2"
WGET_URL="http://libvalhalla.geexbox.org/releases/$TARBALL"

BUILD_DEPENDS="ffmpeg-dev ffmpeg-compat-dev libsqlite3 sqlite3-dev \
libxml2-dev libexif-dev curl-dev"
SPLIT="libvalhalla-dev"

compile_rules() {
	case "$ARCH" in
		arm*)
			export PKG_CONFIG_PATH=/cross/$ARCH/sysroot/usr/lib/ffmpeg-compat/pkgconfig
			export LDFLAGS="$LDFLAGS -Wl,-rpath=/cross/$ARCH/sysroot/usr/lib/ffmpeg-compat"
			export CFLAGS="$CFLAGS -I/cross/$ARCH/sysroot/usr/include/ffmpeg-compat"
			export LDFLAGS="$LDFLAGS -L/cross/$ARCH/sysroot/usr/lib/ffmpeg-compat -lavformat" 
			ARCH_ARGS="--cross-compile"
			;;
		*)
			#export LDFLAGS="$LDFLAGS -lavformat"
			export PKG_CONFIG_PATH=/usr/lib/ffmpeg-compat/pkgconfig
			export LDFLAGS="$LDFLAGS -Wl,-rpath=/usr/lib/ffmpeg-compat"
			;;
	esac

	# Fix Busybox cat
	sed -i 's/cat -n/awk '"'"'{ printf "%6d  %s\\n",++n,$0 }'"'"' </' configure

	./configure \
		--prefix=/usr \
		$ARCH_ARGS &&
	make && make install
}

genpkg_rules() {
	case $PACKAGE in
		libvalhalla)
			mkdir -p $fs/usr/lib
			cp -a $install/usr/lib/*.so* $fs/usr/lib
			DEPENDS="ffmpeg ffmpeg-compat libexif libsqlite3 libxml2 libgcrypt \
			libcurl openssl"
			;;
		*-dev)
			mkdir -p $fs/usr/lib
			cp -a $install/usr/bin $fs/usr
			cp -a $install/usr/lib/*.*a $fs/usr/lib
			cp -a $install/usr/lib/pkgconfig $fs/usr/lib
			cp -a $install/usr/include $fs/usr
			DEPENDS="libvalhalla sqlite3-dev"
			;;
	esac
}
