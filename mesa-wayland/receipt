# SliTaz package receipt v2.

PACKAGE="mesa-wayland"
VERSION="9.1.3"
CATEGORY="x-window"
SHORT_DESC="3D Graphics Library that is an open-source implementaton of OpenGL"
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="MIT"
WEB_SITE="http://www.mesa3d.org/"

TARBALL="MesaLib-$VERSION.tar.bz2"
WGET_URL="ftp://ftp.freedesktop.org/pub/mesa/$VERSION/$TARBALL"

BUILD_DEPENDS_arm="expat-dev libdrm-dev xorg-libXdamage-dev pkg-config \
xorg-libXxf86vm-dev xorg-libXt-dev xorg-dri2proto xorg-glproto \
lesstif libxml2-python lesstif-dev xorg-server-dev udev-dev wayland-dev gettext"
BUILD_DEPENDS="expat-dev libdrm-dev xorg-libXdamage-dev pkg-config \
xorg-libXxf86vm-dev xorg-libXt-dev xorg-dri2proto xorg-glproto lesstif \
libxml2-python lesstif-dev xorg-server-dev udev-dev wayland-dev gettext talloc \
xorg-makedepend xorg-imake file libdrm-nouveau llvm libtool automake autoconf \
libpthread-stubs-dev"
SPLIT="mesa-wayland-dev"

compile_rules() {
	find . -name 'nouveau*.h' \
	| xargs sed -i 's|libdrm/nouveau.h|libdrm/nouveau/nouveau.h|'
	./autogen.sh \
		--prefix=/usr \
		--sysconfdir=/etc/X11/${PACKAGE} \
		--enable-gles2 \
		--disable-gallium-egl \
		--with-egl-platforms=x11,wayland,drm \
		--enable-gbm \
		--enable-shared-glapi \
		--with-gallium-drivers=r300,r600,swrast,nouveau \
		$CONFIGURE_ARGS &&
	make $MAKEFLAGS && make install
}

genpkg_rules() {
	case $PACKAGE in
		mesa-wayland)
			mkdir -p $fs/usr/lib/dri
			cp -a $install/etc $fs
			cp -a $install/usr/lib/*.so* $fs/usr/lib
			cp -a $install/usr/lib/dri/*.so* $fs/usr/lib/dri

			# libGLU is included in the package libglu-mesa
			#rm -r -f $fs/usr/lib/libGLU*

			#libGLw is included in the package libglw-mesa
			#rm -r -f $fs/usr/lib/libGLw*

			#libEGL is included in the package libegl-mesa
			#rm -r -f $fs/usr/lib/libEGL*
			DEPENDS="expat libdrm xorg-libXdamage xorg-libXxf86vm xorg-libXt \
			udev wayland"
			SUGGESTED="nvidia"
			# Have Wayland support by default ?
			PROVIDE="libgl libegl-mesa libglw-mesa"
			;;
		*-dev)
			mkdir -p $fs/usr/lib/dri
			cp -a $install/usr/include $fs/usr
			cp -a $install/usr/lib/*.*a $fs/usr/lib
			cp -a $install/usr/lib/dri/*.*a $fs/usr/lib/dri
			cp -a $install/usr/lib/pkgconfig $fs/usr/lib
			DEPENDS="mesa-wayland udev-dev"
			;;
	esac
}

