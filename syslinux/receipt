# SliTaz package receipt v2.

PACKAGE="syslinux"
VERSION="4.06"
CATEGORY="base-system"
SHORT_DESC="LiveCD ISO bootloader (isolinux)"
MAINTAINER="pankso@slitaz.org"
LICENSE="GPL2"
TARBALL="$PACKAGE-$VERSION.tar.xz"
WEB_SITE="http://syslinux.zytor.com/"
WGET_URL="https://www.kernel.org/pub/linux/utils/boot/syslinux/$TARBALL"
LINLD="$WOK/linld/source"
TAGS="boot"

DEPENDS="ipxe memtest"
BUILD_DEPENDS="kbd-base perl nasm dev86 lzma mingw32-gcc upx posixovl \
util-linux-uuid-dev advancecomp libidn linld python"
SPLIT="syslinux syslinux-extra syslinux-modules syslinux-tools"

# Rules to gen a SliTaz package suitable for Tazpkg.
compile_rules()
{
	rm -f $src/core/isolinux.bin
	cp -f $stuff/slitaz-next/miniacc.h $src/lzo/src/ # use latest https://raw.githubusercontent.com/upx/upx/master/src/miniacc.h
	cp $stuff/tools/isohybrid.sh .
	cp $stuff/extra/md5sum.c com32/modules
	grep -q md5sum.c32 com32/modules/Makefile ||
		sed -i 's/ifcpu64.c32/ifcpu64.c32 md5sum.c32/' com32/modules/Makefile
	export LDFLAGS=''
	make clean
	echo "make all: LDFLAGS=$LDFLAGS"
	make all 2>&1 | sed 's/NO_WERROR=1/NO_Werror=1/;/syslinux64.exe/d'
	echo "make core: LDFLAGS=$LDFLAGS"
	make -C core
	make -C com32
	./isohybrid.sh --build
	sed -i 's/loadkeys -m/loadkeys -u -m/' utils/keytab-lilo	# for ru.kbd
	mkdir kbd
	for i in /usr/share/kbd/keymaps/i386/*/*.map.gz; do
		[ "$(basename $(dirname $i))" == 'include' ] && continue
		utils/keytab-lilo /usr/share/kbd/keymaps/i386/qwerty/us.map.gz \
			$i > kbd/$(basename $i .map.gz)
	done
	cp -a $stuff/iso2exe .
	cp $LINLD/*/tazboot.com iso2exe/boot.com
	make -C iso2exe
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	case $PACKAGE in
	syslinux)
		CONFIG_FILES="/boot/isolinux/*.cfg /boot/isolinux/kbd"
		mkdir -p $fs/boot/isolinux $install/usr/share/doc
		cp $stuff/iso2exe/README* $install/usr/share/doc
		cp $stuff/iso2exe/init.custom $install/usr/share/doc
		cp $src/doc/*.txt $install/usr/share/doc
		cp -a $src/man $install/usr/share/
		cp $LINLD/*/linld.com $fs/boot
		cp -a $src/core/isolinux.bin $fs/boot/isolinux
		lzma e $src/com32/modules/md5sum.c32 $fs/boot/isolinux/c32box.c32
		lzma e $src/com32/menu/vesamenu.c32 $fs/boot/isolinux/vesamenu.c32
		# $stuff/isolinux.msg is the old way the have a splash image.
		cp $stuff/*.cfg $stuff/*.txt $stuff/help.* $stuff/opts.* $fs/boot/isolinux
		rm -f $fs/boot/isolinux/common.cfg $fs/boot/isolinux/default.cfg
			rm -f $fs/boot/isolinux/display.txt
		while read label kbd loc tz menu; do
			for i in ${kbd/,/ }; do
				[ -e $src/kbd/$i ] || continue
				map=" $i"
				[ ${kbd#*,} == $i ] && map=
				cat >> $fs/boot/isolinux/i18n.cfg <<EOT
LABEL $label
	MENU LABEL $menu
	com32 c32box.c32
	append kbd$map lang=$loc kmap=${kbd#*,} tz=$tz

EOT
				break
			done
		done <<EOT
br		br-abnt2	pt_BR	America/Sao_Paulo	Brasil (abnt2)
br_ac\ brac	us-acentos	pt_BR	America/Sao_Paulo	Brasil (us-acentos)
cz		cz-lat2		cs_CZ	Europe/Prague		Cesky
dk		dk-latin1	da_DK	Europe/Copenhagen	Dansk
de		de-latin1	de_DE	Europe/Berlin		Deutsch
de_CH\ deCH	de_CH-latin1	de_CH	Europe/Zurich		Deutsch Schweiz
gr		gr		el_GR	Europe/Helsinki		Ellinika
en		uk		en_GB	Europe/London		English UK
us		us		en_US	America/New_York	English US
us_ac\ usac	us-acentos	en_US	America/New_York	English US (acentos)
us_dv\ usdv	dvorak		en_US	America/New_York	English US (dvorak)
us_dl\ usdl	dvorak-l	en_US	America/New_York	English US (dvorak-l)
us_dr\ usdr	dvorak-r	en_US	America/New_York	English US (dvorak-r)
es		es		es_ES	Europe/Madrid		Espanol
fr		fr-latin1	fr_FR	Europe/Paris		Francais
be		be-latin1	fr_BE	Europe/Brussels		Francais Belgique
ca		cf		fr_CA	America/Montreal	Francais Canada
fr_CH\ frCH	fr_CH-latin1	fr_CH	Europe/Zurich		Francais Suisse
cr		hr,croat	hr_HR	Europe/Zagreb		Hrvatski
is		is-latin1	is_IS	Atlantic/Reykjavik	Islenska
it		it		it_IT	Europe/Rome		Italiano
hu		hu		hu_HU	Europe/Budapest		Magyar
nl		nl2		nl_NL	Europe/Amsterdam	Nederlands
no\ nb		no-latin1	nb_NO	Europe/Oslo		Norsk (Bokmal)
nn		no-latin1	nn_NO	Europe/Oslo		Norsk (Nynorsk)
po		pl2		pl_PL	Europe/Warsaw		Polski
pt		pt-latin1	pt_PT	Europe/Lisbon		Portugues
ru		ru		ru_RU	Europe/Moscow		Russian
ru_uk\ uk	ru		ru_UA	Europe/Kiev		Russian Ukraine
sl		slovene		sl_SI	Europe/Ljubljana	Slovenski
fi		fi		fi_FI	Europe/Helsinki		Suomi
se		se-lat6		sv_SE	Europe/Stockholm	Svenska
tr		trq		tr_TR	Asia/Istanbul		Turkce
EOT
#hr		croat		hr_HR	Europe/Zagreb		Hrvatski
#grpc		gr-pc		el_GR	Europe/Helsinki		Ellinika
#jp		jp106		ja_JP	Asia/Tokyo		Japanese
#sg		sg-latin1	de_CH	Europe/Zurich		Deutsch Schweiz (sg)
#tr5		tr_q-latin5	tr_TR	Asia/Istanbul		Turkce (latin5)

		cat >> $fs/boot/isolinux/i18n.cfg <<EOT
LABEL exit
	MENU LABEL Back to main menu

MENU EXIT
MENU END
EOT
		sed -i 's/^LABEL us$/&\n	MENU DEFAULT/' $fs/boot/isolinux/i18n.cfg
		chown root.root $src/kbd/*
		touch -r $src $src/kbd/*
		for kbd in $(cd $src/kbd; ls | tee ../kbd.l); do
			msg="Invalid file kbd/$kbd"
			[ -s $src/kbd/$kbd ] && msg="Unused: file kbd/$kbd" &&
				grep -q "[= ]$kbd " $fs/boot/isolinux/i18n.cfg && continue
			sed -i "/^$kbd\$/d" $src/kbd.l
			echo "$msg"
		done
		( cd $src/kbd; cat ../kbd.l | cpio -o -H newc ) >$fs/boot/isolinux/kbd
		lzma e $fs/boot/isolinux/kbd $fs/boot/isolinux/kbd.lzma
		mv -f $fs/boot/isolinux/kbd.lzma $fs/boot/isolinux/kbd
		chown root.root $fs/boot/isolinux/*
		;;
	syslinux-extra)
		CAT="system-tools|MBR/FAT/EXT3/PXE bootloader files"
		DEPENDS="syslinux posixovl"
		mkdir -p $fs/usr/share/boot $fs/usr/bin $fs/bin
		lzma e $src/memdisk/memdisk $fs/usr/share/boot/memdisk.lzma 2> /dev/null
		cp -a $src/mbr/mbr.bin $fs/usr/share/boot
		cp -a $src/mbr/gptmbr.bin $fs/usr/share/boot
		lzma e $src/core/pxelinux.0 $fs/usr/share/boot/pxelinux.0.lzma 2> /dev/null
		#lzma e $src/com32/menu/vesamenu.c32 $fs/usr/share/boot/vesamenu.c32
		#lzma e $src/com32/modules/mboot.c32 $fs/usr/share/boot/mboot.c32
		lzma e $src/com32/modules/sdi.c32 $fs/usr/share/boot/sdi.c32
		cp -a $src/linux/syslinux-nomtools $fs/bin/syslinux
		cp -a $src/extlinux/extlinux $fs/bin
		cp -a $src/isohybrid.sh $fs/usr/bin/isohybrid
		cp -a $src/iso2exe/iso2exe $fs/usr/bin/iso2exe
		cp -a $src/iso2exe/taziso $fs/usr/bin
		cp -a $src/iso2exe/README.custom $fs/usr/share/boot
		cp -a $src/iso2exe/init.custom $fs/usr/share/boot
		chown root.root $fs/usr/share/boot/* $fs/bin/* $fs/usr/bin/*
		;;
	syslinux-modules)
		CAT="system-tools|modules for syslinux"
		mkdir -p $fs/usr/share/boot
		for i in $src/com32/*/*.c32 ; do
			case "$i" in
			*/reboot.c32|*/ifmem.c32|*/vesamenu.c32) continue;;
			esac
			lzma e $i $fs/usr/share/boot/$(basename $i) 2> /dev/null
		done
		for i in $src/modules/*.com ; do
			case "$i" in
			*/poweroff.com) continue;;
			esac
			cp $i $fs/usr/share/boot/$(basename $i) 2> /dev/null
		done
		;;
	syslinux-tools)
		CAT="system-tools|Misc perl tools"
		DEPENDS="perl"
		mkdir -p $fs/usr/bin $fs/usr/share/boot
		for i in keytab-lilo lss16toppm ppmtolss16 mkdiskimage \
			 syslinux2ansi isohybrid ; do
			cp -a $src/utils/$i $fs/usr/bin
		done
		cp -a $src/iso2exe/isohybrid.exe $fs/usr/share/boot
		cp -a $src/iso2exe/meminfo.exe $fs/usr/share/boot
		cp -a $src/iso2exe/tazboot.exe $fs/usr/share/boot
		find $fs/usr -exec chown root.root {} \;
		;;
	esac
}

# Pre and post install commands for Tazpkg.
post_install_syslinux()
{
	sed -i "/MENU TITLE SliTaz GNU\/Linux/ s| [0-9X]*$| $(date +%Y%m%d)|" \
		"$1/boot/isolinux/isolinux.cfg"
	sed '/MENU TITLE/!d;s/MENU TITLE //' > $1/etc/slitaz-version \
		< "$1/boot/isolinux/isolinux.cfg"
}
