# SliTaz package receipt v2.

PACKAGE="nzbget"
VERSION="13.0"
CATEGORY="network"
SHORT_DESC="The most efficient usenet downloader"
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="GPL2"
WEB_SITE="http://nzbget.net/"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="$SF_MIRROR/nzbget/nzbget-stable/$VERSION/$TARBALL"

BUILD_DEPENDS="libxml2-dev openssl-dev ncurses-dev zlib-dev"
SPLIT="nzbget-webui nzbget"

compile_rules() {
	./configure \
		--disable-parcheck \
		$CONFIGURE_ARGS &&
	make &&
	make -j1 DESTDIR=$DESTDIR install || return 1

	mkdir -p $install/etc/
	mv $install/usr/share/nzbget/nzbget.conf $install/etc/
}

genpkg_rules() {
	case $PACKAGE in
		nzbget-webui)
			copy usr/share/nzbget/webui/
			CAT="network|web user interface"
			DEPENDS="nzbget"
			;;
		nzbget)
			copy @std @rm
			DEPENDS="libxml2 openssl ncurses gcc-lib-base"
			CONFIG_FILES="/etc/nzbget.conf"
			;;
	esac
}

post_install_nzbget_webui() {
	# Configure lighttpd server
	if [ -f "$1/etc/lighttpd/lighttpd.conf" ]; then
		if ! grep -q /usr/share/nzbget/ "$1/etc/lighttpd/lighttpd.conf"; then
			sed -e 's|.*"/examples/" => "/usr/share/examples/",|    "/examples/" => "/usr/share/examples/",\n    "/nzbget/" => "/usr/share/nzbget/webui/",|g' -i "$1/etc/lighttpd/lighttpd.conf"
			if [ -z "$1" ]; then
				# Start Web server.
				/etc/init.d/lighttpd stop
				/etc/init.d/lighttpd start
			fi
		fi
	fi
	# Configure apache server
	if [ -f "$1/etc/apache/httpd.conf" ]; then
		if [ ! -f "$1/etc/apache/conf.d/nzbget" ]; then
			cat > "$1/etc/apache/conf.d/nzbget" <<EOT
<IfModule mod_alias.c>
    Alias /nzbget /usr/share/nzbget/webui
</IfModule>
<Directory /usr/share/nzbget/webui/>
    DirectoryIndex index.html
    Options +FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
</Directory>
EOT
			if [ -z "$1" ]; then
				# Start Web server.
				/etc/init.d/apache stop
				/etc/init.d/apache start
			fi
		fi
	fi
}
