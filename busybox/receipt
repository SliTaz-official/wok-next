# SliTaz package receipt.

PACKAGE="busybox"
VERSION="1.26.1"
CATEGORY="base-system"
SHORT_DESC="Busybox combines tiny versions of many common UNIX utilities."
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="GPL2"
WEB_SITE="https://busybox.net/"
HOST_ARCH="i486 arm"

TARBALL="$PACKAGE-$VERSION.tar.bz2"
WGET_URL="${WEB_SITE}downloads/$TARBALL"

DEPENDS="slitaz-base-files glibc-base ncurses"
BUILD_DEPENDS="bzip2 gettext perl"
SIBLINGS="busybox-boot busybox-pam busybox-static ssfs-busybox busybox-slish"

CONFIG_FILES="/etc/dnsd.conf /etc/inetd.conf /etc/udhcpd.conf \
/etc/resolv.conf /etc/httpd.conf"

# Handle cross compilation
case "$ARCH" in
	arm*) BUILD_DEPENDS="bzip2" ;;
esac

# Busybox patches
apply_bb_patchs()
{
	while read file; do
		[ -f done.$file ] && continue
		echo "Apply $file..."
		patch -p1 < $stuff/${VERSION%.*}/$file || return 1
		touch done.$file
	done <<EOT
tar.u
stat.u
zmodules.u
printable.u
cmdline.u
diet.u
losetup.u
fbvnc.u
cpio.u
EOT
	# Failed: ris.u diff.u ftpd.u dpkgxz.u shutdown.u
	cp $stuff/${VERSION%.*}/.config .
}

# Rules to configure and make the package.
compile_rules()
{
	case "$ARCH" in
		arm*)
			echo "cook: CROSS_COMPILE=$CROSS_COMPILE"
			apply_bb_patchs &&
			cp $stuff/arm/$PACKAGE.config .config
			make oldconfig &&
			make && make install || return 1
			chmod 4755 $src/_install/bin/busybox
			;;
		x86_64)
			echo "TODO"
			;;
		i?86)
			echo 'Making busybox'
			apply_bb_patchs &&
			make oldconfig &&
			make && make install || return 1
			strip --strip-unneeded -R .eh_frame -R .eh_frame_hdr \
				$src/_install/bin/busybox

			echo 'Making translations'
			make -C $stuff/po install
			;;

	esac

	cook_pick_manpages $src/docs/busybox.1

	mkdir -p $install/usr/share/doc/busybox
	cp -a $src/docs/*.txt  $install/usr/share/doc/busybox
	cp -a $src/docs/*.htm* $install/usr/share/doc/busybox
	cp -a $src/docs/cgi    $install/usr/share/doc/busybox
}

# Cross compilation check.
testsuite()
{
	readelf -h $src/_install/bin/busybox
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	cp -a $src/_install/* $fs
	[ -e $fs/sbin/ip ] && ln -s busybox $fs/bin/ip
	rm -f $fs/bin/bbconfig $fs/usr/bin/ar
	mkdir -p $fs/etc/init.d $fs/var/spool/cron/crontabs $fs/var/spool/lpd \
		 $fs/var/lib/misc

	# Busybox config files.
	for f in busybox.conf dnsd.conf udhcpd.conf inetd.conf httpd.conf \
		syslog.conf zcip.script
	do
		cp $stuff/$f $fs/etc
	done
	chown -R 0.0 $fs/etc
	chmod 600 $fs/etc/busybox.conf
	touch $fs/etc/resolv.conf

	# Daemon scripts.
	cp $stuff/daemon $fs/etc/init.d
	DAEMON="crond dnsd ftpd httpd inetd lpd klogd ntpd syslogd telnetd tftpd udhcpd zcip"
	for i in $DAEMON; do
		grep -qi config_$i=y $stuff/${VERSION%.*}/.config &&
		ln -s daemon $fs/etc/init.d/$i
	done
	rm $fs/linuxrc
	mkdir -p $fs/etc/modprobe.d

	# Udhcpc stuff.
	mkdir -p $fs/usr/share/udhcpc
	cp $stuff/udhcp.script $fs/usr/share/udhcpc/default.script
	chmod +x $fs/usr/share/udhcpc/default.script

	# Httpd stuff.
	ln -s /usr/lib/slitaz/httphelper.sh $fs/usr/bin/httpd_helper.sh
	cp -a $stuff/www $fs/var

	# Update copyright year
	grep -rl 'copy; 2' $fs/var/www | xargs \
		sed -i "s/copy; [0-9]*/copy; $(date +%Y)/"

	# Remove kmod & core-util-mount links
	while read link; do
		rm -f $fs$link
	done <<EOT
/sbin/depmod
/sbin/insmod
/sbin/modinfo
/sbin/modprobe
/sbin/rmmod
EOT
#/bin/mount
#/bin/mountpoint
#/bin/umount
	:
}

# GNU utils stuff.
pre_install()
{
	local i
	[ -s $1/etc/resolv.conf ] &&
	cp -a $1/etc/resolv.conf $1/etc/resolv.conf-busybox-install
	answer=""
	for i in $(sed '/busybox$/d; /bin\//!d' "$1$INSTALLED/$PACKAGE/files.list"); do
		[ -f "$1$i" ] || continue
		if [ -z "$answer" ]; then
			confirm 'Keep installed GNU utilities?' y || break
			answer='Y'
		fi
		cp -a "$1$i" "$1$i-busybox-install"
	done
}

post_install()
{
	local i
	[ -f $1/etc/resolv.conf-busybox-install ] &&
	mv -f $1/etc/resolv.conf-busybox-install $1/etc/resolv.conf
	for i in $($1/bin/busybox --list-full); do
		[ -f "$1/$i-busybox-install" ] || continue
		mv "$1/$i-busybox-install" "$1/$i"
	done
	chmod 4755 "$1/bin/busybox"

	touch "$1/etc/daemons.conf"
	# /etc/daemons.conf (tftp + dnsd + httpd may not be present)
	if ! grep -q ^DNSD_OPTIONS "$1/etc/daemons.conf"; then
		cat >> "$1/etc/daemons.conf" <<EOF
# Domain name server options.
DNSD_OPTIONS="-d"

EOF
	fi
	if ! grep -q ^TFTPD_OPTIONS $1/etc/daemons.conf; then
		cat >> "$1/etc/daemons.conf" <<EOF
# Tftp daemon options.
TFTPD_OPTIONS="-r /boot"

EOF
	fi
	sed -i "s/copy; 20../copy; $(date +%Y)/" $1/var/www/httpd/404.html
}

pre_remove()
{
	# We can not remove this package!
	exit 1
}
