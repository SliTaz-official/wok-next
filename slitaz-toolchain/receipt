# SliTaz package receipt v2.

PACKAGE="slitaz-toolchain"
VERSION="6.0"
CATEGORY="meta"
SHORT_DESC="SliTaz meta package to rebuild or install current toolchain"
MAINTAINER="pankso@slitaz.org"
LICENSE="GPL2"
WEB_SITE="http://www.slitaz.org/"

# The goal here is to build and install SliTaz toolchain. We build the toolchain
# from SliTaz packages, on SliTaz and for SliTaz so in case of new and important
# toolchain upgrade we must build Binutils a first time, then GCC so it use the
# new Binutils. After we cook Glibc and then rebuild Binutils + GCC a second
# time so they are linked with the new main GNU libc. We usually also due a
# bootstrap by recooking slitaz-toolchain a second time so we are sure it can
# rebuild itself.
#
# SliTaz does one big toolchain by year just after the stable release, any change
# here or in the toolchain packages version must be discuss on the mailing list.

ver() { grep ^VERSION $WOK/$1/receipt | cut -d '"' -f2; }

# Rules to configure and make the package.
compile_rules()
{
	[ -x /usr/bin/cook ] || return 0

	tmplog=$LOGS/$PACKAGE.tmplog

	cat > $tmplog <<EOT
Cook: $PACKAGE $VERSION
$(separator)
Cook toolchain : started $(date '+%F %R')
Architecture   : $ARCH
Build system   : $BUILD_SYSTEM
Host  system   : $HOST_SYSTEM
$(separator -)
EOT

	echo "cook: Binutils first pass : $(date '+%F %R')" >> $tmplog
	cook binutils
	echo "cook: GCC first pass      : $(date '+%F %R')" >> $tmplog
	cook gcc --first-pass
	echo "cook: Linux API headers   : $(date '+%F %R')" >> $tmplog
	cook linux-api-headers
	echo "cook: Glibc               : $(date '+%F %R')" >> $tmplog
	cook glibc
	echo "cook: Binutils final      : $(date '+%F %R')" >> $tmplog
	cook binutils
	echo "cook: GCC final           : $(date '+%F %R')" >> $tmplog
	cook gcc

	cat >> $tmplog <<EOT
$(separator)

GCC compiler information
$(separator)
$(gcc -v 2>&1 | sed 's|--|\n  --|g')
$(separator)

EOT

	# All packages cooked got ther own log so we don't keep them.
	mv -f $tmplog $LOGS/$PACKAGE.log

	mkdir -p $install/usr/share/doc/slitaz
	cat > $install/usr/share/doc/slitaz/toolchain.txt <<EOT
SliTaz GNU/Linux toolchain
================================================================================

Build date   : $(date "+%F")
Architecture : $ARCH
Build system : $BUILD_SYSTEM
Host  system : $HOST_SYSTEM

Packages:

  * Binutils $(ver binutils)
  * Linux API headers $(ver linux-api-headers)
  * GCC $(ver gcc)
  * Glibc $(ver glibc)

Toolchain documentation: http://doc.slitaz.org/en:cookbook:toolchain

================================================================================

EOT
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	copy @std
	DEPENDS="binutils linux-api-headers glibc-dev gcc make elfkickers"
}
