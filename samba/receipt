# SliTaz package receipt v2.

PACKAGE="samba"
VERSION="4.6.7"
CATEGORY="system-tools"
SHORT_DESC="File and print services with SMB/CIFS"
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="GPL3"
WEB_SITE="https://www.samba.org/"
BUGS="Open directory needs MIT kerberos support (krb5)"
COOKOPTS="!menus"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="https://download.samba.org/pub/samba/stable/$TARBALL"

BUILD_DEPENDS="python-dev perl acl-dev docbook-xsl openldap-dev   \
gnutls-dev krb5-dev cyrus-sasl-dev zlib-dev popt-dev libtdb-dev talloc-dev \
libgcrypt-dev nss-dev cups-dev dbus-dev pam pam-dev"
SPLIT="samba samba-pam samba-dev" # TODO: swat

version() {
	wget -O- -q https://download.samba.org/pub/samba/ | \
	sed '/LATEST-IS-SAMBA/!d; s|.*SAMBA-\([^<]*\).*|\1|'
}

# Rules to configure and make the package.
compile_rules()
{
	# http://www.linuxfromscratch.org/blfs/view/stable/basicnet/samba.html

	cp -a $src $src-pam
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--with-piddir=/run/samba \
		--with-pammodulesdir=/lib/security \
		--enable-fhs \
		--without-pam \
		--without-ad-dc \
		--without-systemd \
		--enable-selftest \
		$CONFIGURE_ARGS &&
	make && make install || return 1

	cd $src-pam
	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--with-piddir=/run/samba \
		--with-pammodulesdir=/lib/security \
		--enable-fhs \
		--with-pam \
		--without-ad-dc \
		--without-systemd \
		--enable-selftest \
		$CONFIGURE_ARGS &&
	make && make DESTDIR=install-pam || return 1

	for inst in $install $install-pam ; do
		mkdir -p $inst/lib
		mv $inst/usr/lib/libnss_wins.so* $inst/usr/lib/libnss_winbind.so* \
			$inst/lib
		ln -sf ../../lib/libnss_winbind.so.2 $inst/usr/lib/libnss_winbind.so
		ln -sf ../../lib/libnss_wins.so.2    $inst/usr/lib/libnss_wins.so

		install -m644 examples/smb.conf.default $inst/etc/samba

		mkdir -pv $inst/etc/openldap/schema
		cp examples/LDAP/README $inst/etc/openldap/schema/README.LDAP
		cp examples/LDAP/samba* $inst/etc/openldap/schema
		cp -r examples/LDAP/get* examples/LDAP/ol* $inst/etc/openldap/schema

		cp -a $stuff/etc $inst

		# Symlink smbspool to cups backend
		mkdir -p $inst/usr/lib/cups/backend
		ln -sf /usr/bin/smbspool $inst/usr/lib/cups/backend/smb

		# for swat package
#		icodir="$inst/usr/share/icons/hicolor/48x48/apps"
#		mkdir -p $icodir
#		cp $stuff/swat.png $icodir

		chown -R root:root $inst
	done
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	# Note, packages samba-common, smbclient was removed due to circular dependencies:
	# smbclient <--> samba <--> samba-common
	case $PACKAGE in
#		smbclient)
#			copy smbclient smbspool smbget smbtree smbcacls smbcquotas smbtar \
#			rpcclient net nmblookup libnetapi.so* libsmbclient.so* smb
#			CAT="network|client"
#			DEPENDS="samba libldap libtdb popt talloc"
#			;;
#		swat)
#			copy swat/ swat.desktop swat.png
#			CAT="development|Samba Web Administration Tool"
#			DEPENDS="samba"
#			;;
		samba)
			copy @std
#			remove_already_packed
			DEPENDS="acl attr dbus libcups libgnutls libldap libtdb ncurses \
			ncurses-libform ncurses-libpanel perl popt python talloc \
			talloc-python zlib"
			PROVIDE="samba-common smbclient"
			TAZPANEL_DAEMON="man|edit::/etc/samba/smb.conf|web::$WEB_SITE"
			CONFIG_FILES="/etc/samba/smb.conf"
			;;
		samba-pam)
			CAT="system-tools|using PAM"
			install=$install-pam copy @std
#			remove by hand already packed files...
			DEPENDS="acl attr dbus libcups libgnutls libldap libtdb ncurses \
			ncurses-libform ncurses-libpanel perl popt python talloc \
			talloc-python zlib pam"
			PROVIDE="samba:pam samba-common smbclient"
			TAZPANEL_DAEMON="man::samba|edit::/etc/samba/smb.conf|web::$WEB_SITE"
			CONFIG_FILES="/etc/samba/smb.conf"
			;;
		*-dev)
			copy @dev
			DEPENDS="samba talloc-dev"
			;;
	esac
}

# Pre and post install commands for Tazpkg.
post_install_samba() {
	[ -n "$quiet" ] || cat <<EOT

	.----------------------------------------------------.
	| The main configuration file is /etc/samba/smb.conf |
	|----------------------------------------------------|
	| To start samba server you can run:                 |
	|     /etc/init.d/samba start                        |
	|                                                    |
	| Or add samba to RUN_DAEMONS in /etc/rcS.conf       |
	'----------------------------------------------------'
EOT
}

post_install_swat() {
	[ -f "$1/etc/lighttpd/lighttpd.conf" ] || return

	[ ! grep -q /usr/share/samba/swat/ "$1/etc/lighttpd/lighttpd.conf" ] || return

	sed -e 's|.*"/examples/" => "/usr/share/examples/",|    "/examples/" => "/usr/share/examples/",\n    "/swat/" => "/usr/share/samba/swat/",|g' -i "$1/etc/lighttpd/lighttpd.conf"

	[ -z "$1" ] || return
	# Start Web server.
	/etc/init.d/lighttpd stop
	/etc/init.d/lighttpd start
}
