# SliTaz package receipt.

PACKAGE="linux-cloop"
SOURCE="cloop"
GITHASH="9acc0fcad420b5ff7062fdd1c90d27ada5278b97" # 3.14
VERSION="${GITHASH:0:7}"
CATEGORY="base-system"
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="GPL2"
SHORT_DESC="The read-only compressed loop device kernel module."
WEB_SITE="http://knoppix.net/wiki/Cloop"
TARBALL="$SOURCE-$VERSION.zip"
WGET_URL="http://debian-knoppix.alioth.debian.org/packages/$SOURCE/$TARBALL"
WGET_URL="https://github.com/KlausKnopper/cloop/archive/$GITHASH.zip"

DEPENDS="linux"
BUILD_DEPENDS="linux-module-headers xz"
SUGGESTED="cloop-utils"

# Rules to configure and make the package.

compile_rules()
{
	patch -p0 < $stuff/cloop.u
	# use f_inode with linux > 3.19
	sed -i  -e 's|f_dentry->d_inode|f_inode|' \
		-e 's|&& rw != READA|\n#if LINUX_VERSION_CODE < KERNEL_VERSION(4, 8, 0)\n&\n#endif|' \
		-e 's|.*blk_queue_merge_bvec.*|#if LINUX_VERSION_CODE < KERNEL_VERSION(4, 3, 0)\n&\n#endif|' \
			cloop.c
	make KERNEL_DIR="/usr/src/linux" cloop.ko && xz cloop.ko
}
	
# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{	
	EXTRAVERSION=_$kvers
	mkdir -p $fs/lib/modules/$kvers-slitaz/kernel/misc $fs/dev $fs/usr/bin
	cp $src/cloop_suspend $fs/usr/bin
	cp $src/cloop.ko.xz $fs/lib/modules/$kvers-slitaz/kernel/misc
	for i in $(seq 0 7); do
		mknod $fs/dev/cloop$i b 240 $i
	done
}

post_install()
{
	chroot "$1/" depmod -a ${EXTRAVERSION#_}-slitaz
}

post_remove()
{
	depmod -a
}
