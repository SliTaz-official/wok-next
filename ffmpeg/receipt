# SliTaz package receipt v2.

PACKAGE="ffmpeg"
VERSION="3.4.2"
CATEGORY="multimedia"
SHORT_DESC="Record, convert and stream audio and video"
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="GPL2 LGPL2.1"
WEB_SITE="http://ffmpeg.org/"
LFS="http://www.linuxfromscratch.org/blfs/view/stable/multimedia/ffmpeg.html"

TARBALL="$PACKAGE-$VERSION.tar.xz"
WGET_URL="${WEB_SITE}releases/$TARBALL"

BUILD_DEPENDS_arm="zlib-dev bzip2-dev yasm"
BUILD_DEPENDS="coreutils-file-format libass-dev fdk-aac-dev lame-dev opus-dev \
libtheora-dev libvorbis-dev libvpx-dev x264-dev x265-dev xorg-libX11-dev \
libsdl2-dev yasm"
SPLIT="ffplay ffserver ffmpeg-dev ffmpeg"

compile_rules() {
	case "$ARCH" in
		i?86) ARCH_ARGS="--arch=$ARCH --cpu=$ARCH" ;;
		arm*) ARCH_ARGS="--enable-cross-compile --arch=armel --target-os=linux \
			--cross-prefix=$HOST_SYSTEM-" ;;
	esac

	sed -i 's|-lflite"|-lflite -lasound"|' configure
	./configure \
		--prefix=/usr \
		--enable-gpl \
		--enable-version3 \
		--enable-nonfree \
		--disable-static \
		--enable-shared \
		--disable-debug \
		--enable-libass \
		--enable-libfdk-aac \
		--enable-libfreetype \
		--enable-libmp3lame \
		--enable-libopus \
		--enable-libtheora \
		--enable-libvorbis \
		--enable-libvpx \
		--enable-libx264 \
		--enable-libx265 \
		--docdir=/usr/share/doc/ffmpeg-$VERSION \
		\
		--enable-runtime-cpudetect \
		$ARCH_ARGS &&
	make &&
	gcc tools/qt-faststart.c -o tools/qt-faststart &&
	make install || return 1

	install -v -m755 tools/qt-faststart $install/usr/bin
	install -Dm644 $stuff/ffserver.conf $install/etc/ffserver.conf

	cook_pick_docs doc/*.txt
}

genpkg_rules() {
	case $PACKAGE in
		ffplay)
			copy ffplay
			CAT="multimedia|very simple and portable media player using the ffmpeg and the SDL library"
			TAGS="audio video player"
			DEPENDS="ffmpeg libsdl"
			;;
		ffserver)
			copy ffserver ffserver.conf
			CAT="multimedia|FFmpeg audio/video fast and small stream server"
			TAGS="audio video server"
			DEPENDS="ffmpeg"
			;;
		*-dev)
			copy @dev examples/
			DEPENDS="ffmpeg bzip2-dev fdk-aac-dev freetype-dev lame-dev \
			libass-dev libogg-dev libtheora-dev libvorbis-dev libvpx-dev \
			opus-dev x264-dev x265-dev xorg-libX11-dev xorg-libxcb-dev xz-dev \
			zlib-dev"
			;;
		ffmpeg)
			copy @std @rm
			SUGGESTED="ffplay"
			TAGS="audio video convert stream"
			DEPENDS="bzlib fdk-aac freetype lame libass liblzma libtheora-enc \
			libvorbis libvpx opus x264 x265 xorg-libxcb zlib"
			case "$SLITAZ_ARCH" in
				arm*) DEPENDS="alsa-lib bzip2 zlib" ;;
			esac
			;;
	esac
}
