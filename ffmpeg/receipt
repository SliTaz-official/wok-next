# SliTaz package receipt v2.

PACKAGE="ffmpeg"
VERSION="3.2.4"
CATEGORY="multimedia"
SHORT_DESC="Record, convert and stream audio and video"
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="GPL2 LGPL2.1"
WEB_SITE="http://ffmpeg.org/"
HOST_ARCH="i486 arm"

TARBALL="$PACKAGE-$VERSION.tar.xz"
WGET_URL="${WEB_SITE}releases/$TARBALL"

BUILD_DEPENDS_arm="zlib-dev bzip2-dev yasm"
#BUILD_DEPENDS="libsdl-dev zlib-dev bzip2-dev coreutils-file-format \
#coreutils-file-special yasm"
BUILD_DEPENDS="coreutils-file-format libass-dev fdk-aac-dev lame-dev opus-dev \
libtheora-dev libvorbis-dev libvpx-dev x264-dev x265-dev xorg-libX11-dev \
libsdl2-dev"
SPLIT="ffmpeg ffmpeg-dev ffserver ffplay"

# Rules to configure and make the package.
compile_rules()
{
	# http://www.linuxfromscratch.org/blfs/view/stable/multimedia/ffmpeg.html

	# Handle cross compilation.
	case "$ARCH" in
		i?86) ARCH_ARGS="--arch=$ARCH --cpu=$ARCH" ;;
		arm*) ARCH_ARGS="--enable-cross-compile --arch=armel --target-os=linux \
			--cross-prefix=$HOST_SYSTEM-" ;;
	esac

	./configure \
		--prefix=/usr \
		--enable-gpl \
		--enable-version3 \
		--enable-nonfree \
		--disable-static \
		--enable-shared \
		--disable-debug \
		--enable-libass \
		--enable-libfdk-aac \
		--enable-libfreetype \
		--enable-libmp3lame \
		--enable-libopus \
		--enable-libtheora \
		--enable-libvorbis \
		--enable-libvpx \
		--enable-libx264 \
		--enable-libx265 \
		--enable-x11grab \
		--docdir=/usr/share/doc/ffmpeg-$VERSION \
		--enable-runtime-cpudetect \
		$ARCH_ARGS &&

#		--enable-avresample \
#		--enable-pthreads \
#		--enable-small \
#		--enable-ffserver \
#		--disable-ffprobe \
#		--disable-encoder=h263 \
#		--disable-encoder=h263p \
#		--disable-encoder=mpeg2video \
#		--disable-encoder=msmpeg4v2 \
#		--disable-encoder=msmpeg4v3 \
#		--disable-symver \
#		--disable-doc \

	make &&
	gcc tools/qt-faststart.c -o tools/qt-faststart &&
	make install &&
	install -v -m755 tools/qt-faststart $install/usr/bin &&
	docdir=$install/usr/share/doc/ffmpeg-$VERSION &&
	mkdir -p $docdir &&
	cp doc/*.txt $docdir
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	case $PACKAGE in
		ffmpeg)
			copy @std
			rm -rf $fs/usr/share/$PACKAGE/examples/
			SUGGESTED="ffplay"
			TAGS="audio video convert stream"
			DEPENDS="bzlib fdk-aac freetype lame libass liblzma libtheora-enc \
			libvorbis libvpx opus x264 x265 xorg-libxcb zlib"
			case "$SLITAZ_ARCH" in
				arm*) DEPENDS="alsa-lib bzip2 zlib" ;;
			esac
			;;
		ffplay)
			CAT="multimedia|Very simple and portable media player using the ffmpeg and the SDL library."
			TAGS="audio video player"
			DEPENDS="ffmpeg libsdl"
			mkdir -p $fs/usr/bin
			cp -a $install/usr/bin/ffplay $fs/usr/bin
			;;
		ffserver)
			CAT="multimedia|FFmpeg audio/video fast and small stream server."
			TAGS="audio video server"
			DEPENDS="ffmpeg"
			mkdir -p $fs/usr/bin $fs/etc
			cp ${stuff}/ffserver.conf $fs/etc
			cp -a $install/usr/bin/ffserver $fs/usr/bin
			;;
		*-dev)
			copy @dev examples/
			DEPENDS="ffmpeg bzip2-dev fdk-aac-dev freetype-dev lame-dev \
			libass-dev libogg-dev libtheora-dev libvorbis-dev libvpx-dev \
			opus-dev x264-dev x265-dev xorg-libX11-dev xorg-libxcb-dev xz-dev \
			zlib-dev"
			;;
	esac
}
