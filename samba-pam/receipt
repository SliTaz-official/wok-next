# SliTaz package receipt v2.

PACKAGE="samba-pam"
VERSION="4.6.7"
CATEGORY="system-tools"
SHORT_DESC="File and print services with SMB/CIFS using PAM"
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="GPL3"
WEB_SITE="https://www.samba.org/"
BUGS="Open directory needs MIT kerberos support (krb5)"
COOKOPTS="!menus"

SOURCE="samba"
TARBALL="$SOURCE-$VERSION.tar.gz"
WGET_URL="https://download.samba.org/pub/samba/stable/$TARBALL"

BUILD_DEPENDS="python-dev perl acl-dev docbook-xsl openldap-dev   \
gnutls-dev krb5-dev cyrus-sasl-dev zlib-dev popt-dev libtdb-dev talloc-dev \
libgcrypt-dev nss-dev cups-dev dbus-dev pam pam-dev"

version() {
	wget -O- -q https://download.samba.org/pub/samba/ | \
	sed '/LATEST-IS-SAMBA/!d; s|.*SAMBA-\([^<]*\).*|\1|'
}

# Rules to configure and make the package.
compile_rules()
{
	# http://www.linuxfromscratch.org/blfs/view/stable/basicnet/samba.html

	./configure \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--with-piddir=/run/samba \
		--with-pammodulesdir=/lib/security \
		--with-pam \
		--enable-fhs \
		--without-ad-dc \
		--without-systemd \
		--enable-selftest \
		$CONFIGURE_ARGS &&
	make && make install || return 1

	mkdir -p $install/lib
	mv $install/usr/lib/libnss_wins.so* $install/usr/lib/libnss_winbind.so* \
		$install/lib
	ln -sf ../../lib/libnss_winbind.so.2 $install/usr/lib/libnss_winbind.so
	ln -sf ../../lib/libnss_wins.so.2    $install/usr/lib/libnss_wins.so

	install -m644 examples/smb.conf.default $install/etc/samba

	mkdir -pv $install/etc/openldap/schema
	cp examples/LDAP/README $install/etc/openldap/schema/README.LDAP
	cp examples/LDAP/samba* $install/etc/openldap/schema
	cp -r examples/LDAP/get* examples/LDAP/ol* $install/etc/openldap/schema

	cp -a $stuff/etc $install

	# Symlink smbspool to cups backend
	mkdir -p $install/usr/lib/cups/backend
	ln -sf /usr/bin/smbspool $install/usr/lib/cups/backend/smb

	# for swat package
#	icodir="$install/usr/share/icons/hicolor/48x48/apps"
#	mkdir -p $icodir
#	cp $stuff/swat.png $icodir

	chown -R root:root $install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	case $PACKAGE in
		samba-pam)
			copy @std
#			remove_already_packed
			PROVIDE="samba:pam"
			DEPENDS="acl attr dbus libcups libgnutls libldap libtdb ncurses \
			ncurses-libform ncurses-libpanel perl popt python talloc \
			talloc-python zlib pam"
			PROVIDE="samba-common smbclient"
			TAZPANEL_DAEMON="man::samba|edit::/etc/samba/smb.conf|web::$WEB_SITE"
			CONFIG_FILES="/etc/samba/smb.conf"
			;;
	esac
}

# Pre and post install commands for Tazpkg.
post_install_samba_pam() {
	[ -n "$quiet" ] || cat <<EOT

	.----------------------------------------------------.
	| The main configuration file is /etc/samba/smb.conf |
	|----------------------------------------------------|
	| To start samba server you can run:                 |
	|     /etc/init.d/samba start                        |
	|                                                    |
	| Or add samba to RUN_DAEMONS in /etc/rcS.conf       |
	'----------------------------------------------------'
EOT
}
