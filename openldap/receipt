# SliTaz package receipt v2.

PACKAGE="openldap"
VERSION="2.4.44"
CATEGORY="misc"
SHORT_DESC="LDAP database system"
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="BSD"
WEB_SITE="http://www.openldap.org/"

TARBALL="$PACKAGE-$VERSION.tgz"
WGET_URL="http://mirror.eu.oneandone.net/software/openldap/openldap-release/$TARBALL"

BUILD_DEPENDS="util-linux-uuid-dev openssl-dev libtool groff"
SPLIT="libldap openldap-dev"

# Rules to configure and make the package.
compile_rules()
{
	./configure \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--libexecdir=/usr/lib \
		--disable-static \
		--disable-debug \
		--with-tls=openssl \
		--enable-dynamic \
		--enable-crypt \
		--disable-bdb \
		--disable-hdb \
		$CONFIGURE_ARGS &&
	sed -i 's|@VERSION_OPTION@||' $src/libraries/*/Makefile &&
	make depend && make && make install

	mkdir -p $install/etc/init.d
	install -m0755 $stuff/etc/init.d/openldap $install/etc/init.d
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	case $PACKAGE in
		openldap)
			copy @std
			find $fs -name '*.so*' -delete
			DEPENDS="libldap libcrypto libssl util-linux-uuid"
			CONFIG_FILES="/etc/openldap/"
			DATABASE_FILES="/var/openldap-*"
			TAZPANEL_DAEMON="man::slapd|help::/usr/libexec/slapd|edit::/etc/openldap/slapd.conf|options::LDAP_OPTIONS|web::$WEB_SITE"
			;;
		libldap)
			copy *.so*
			CAT="libs|libraries"
			DEPENDS="libcrypto libssl"
			;;
		*-dev)
			copy @dev
			DEPENDS="openldap libldap libcrypto-dev openssl-dev";;
	esac
}

# Pre and post install commands for Tazpkg.
post_install_openldap()
{
	chmod 700 "$1/etc/openldap"

	( cd "$1/$INSTALLED/"; grep -l /etc/openldap/slapd.conf */receipt ) | \
	while read file; do
		pkg=$(dirname $file)
		[ "$pkg" == "$PACKAGE" ] && continue
		echo "Reconfiguring $pkg for $PACKAGE..."
		chroot "$1/" tazpkg reconfigure $pkg
	done
}
