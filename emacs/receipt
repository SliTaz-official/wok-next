# SliTaz package receipt v2.

PACKAGE="emacs"
VERSION="25.3"
CATEGORY="editors"
SHORT_DESC="The GNU Emacs editor"
MAINTAINER="domcox@slitaz.org"
LICENSE="GPL3"
WEB_SITE="http://www.gnu.org/software/emacs/"

TARBALL="$PACKAGE-$VERSION.tar.xz"
WGET_URL="$GNU_MIRROR/$PACKAGE/$TARBALL"

BUILD_DEPENDS="atk-dev cairo-dev expat-dev dbus-dev freetype-dev \
fontconfig-dev glib-dev gnutls-dev gtk+-dev jpeg-dev \
libpng16-dev librsvg-dev ncurses-dev pango-dev tiff-dev xorg-dev \
xorg-dev-proto" # giflib-dev: version 4 needed, add --with-gif=no)
SPLIT="emacs-help emacs-lisp-sources emacs"

# Rules to configure and make the package.
compile_rules() {
	./configure \
		--infodir=/usr/share/info \
		--mandir=/usr/share/man \
		--without-makeinfo \
		--without-gconf \
		--with-gif=no --with-jpeg=no \
		--with-sound \
		--with-x \
		--with-toolkit-scroll-bars \
		--with-xpm=yes \
		--libexecdir=/usr/lib \
		--localstatedir=/var/lib \
		--sharedstatedir=/var/lib \
		$CONFIGURE_ARGS &&
	make $MAKEFLAGS &&
	make DESTDIR=$DESTDIR install || return 1

	# Install specific site file
	mkdir -p                   $install/usr/share/emacs/site-lisp/site-start.d
	cp -a $stuff/default.el \
	      $stuff/site-start.el $install/usr/share/emacs/site-lisp/
	cp -a $stuff/90-slitaz.el  $install/usr/share/emacs/site-lisp/site-start.d

	# Use default site-lisp
	ln -s ../site-lisp $install/usr/share/emacs/$VERSION/site-lisp

	chown -R root:root $install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules() {
	case $PACKAGE in
		emacs-help)
			copy \
				info/ \
				tutorials/ \
				refcards/*.pdf \
				etc/[A-Z]* \
				etc/*.txt
			DEPENDS="emacs"
			CAT="development|help files"
			;;
		emacs-lisp-sources)
			copy \
				*.el.gz \
				refcards/*.tex
			DEPENDS="emacs"
			CAT="development|Lisp source files"
			;;
		emacs)
			copy @std @dev @rm
			strip -s $fs/usr/lib/emacs/$VERSION/i486-pc-linux-gnu/* 2>/dev/null
			DEPENDS="atk cairo dbus expat freetype fontconfig giflib glib \
			gnutls gtk+ jpeg libpng16 librsvg util-linux-uuid \
			ncurses pango tiff xorg-server zlib librsvg libgsf \
			libgnutls harfbuzz"
			SUGGESTED="alsa-lib"
			TAGS="text-editor"
		;;
	esac
}

# linking /usr/bin/emacs to new version
post_install_emacs() {
	ln -sf /usr/bin/emacs-$VERSION "$1/usr/bin/emacs"
}

post_remove_emacs() {
	rm -rf "$1/usr/share/emacs"
	rm -rf "$1/usr/lib/emacs"
	rm -f  "$1/usr/bin/emacs"
}
