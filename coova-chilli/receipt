# SliTaz package receipt v2.

PACKAGE="coova-chilli"
VERSION="1.3.0"
CATEGORY="network"
SHORT_DESC="Captive portal or wireless LAN access point controller"
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="GPL3"
WEB_SITE="http://www.coova.org/CoovaChilli"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="http://ap.coova.org/chilli/$TARBALL"

BUILD_DEPENDS="openssl-dev curl-dev perl"
SPLIT="coova-chilli-dev"

compile_rules() {
	sed -i 's|return -1; safe_close|return -1;\n safe_close|' src/redir.c
	sed -i 's|if (.\(safe_write.*\)) /. error ./|\1|' src/garden.c
	./configure \
		--prefix=/usr \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--enable-largelimits \
		--enable-binstatusfile \
		--enable-statusfile \
		--enable-chilliproxy \
		--enable-chilliradsec \
		--enable-chilliredir \
		--with-openssl \
		--with-curl \
		--with-poll \
		--enable-dhcpopt \
		--enable-sessgarden \
		--enable-dnslog \
		--enable-ipwhitelist \
		--enable-redirdnsreq \
		--enable-miniconfig \
		--enable-libjson \
		--enable-layer3 \
		--enable-proxyvsa \
		--enable-miniportal \
		--enable-chilliscript \
		--enable-eapol \
		--enable-uamdomainfile \
		--enable-modules \
		--enable-multiroute \
		$CONFIGURE_ARGS &&
	make &&
	make DESTDIR=$DESTDIR install
}

genpkg_rules() {
	case $PACKAGE in
		coova-chilli)
			mkdir -p $fs/usr/lib/coova-chilli
			cp -a $install/usr/lib/coova-chilli/*.so* $fs/usr/lib/
			cp -a $install/usr/lib/*.so* $fs/usr/lib/
			cp -a $install/usr/sbin $fs/usr/
			cp -a $install/etc $fs/
			DEPENDS="openssl curl libidn"
			;;
		*-dev)
			mkdir -p $fs/usr/lib/coova-chilli
			cp -a $install/usr/lib/coova-chilli/*a $fs/usr/lib/
			cp -a $install/usr/lib/*a $fs/usr/lib/
			cp -a $install/usr/lib/python $fs/usr/lib/
			cp -a $install/usr/include $fs/usr/
			;;
	esac
}
