# SliTaz package receipt v2.

PACKAGE="wpa_supplicant"
VERSION="2.6"
CATEGORY="utilities"
SHORT_DESC="WPA Supplicant with support for WPA and WPA2"
MAINTAINER="0dddba11@googlemail.com"
LICENSE="GPL2"
WEB_SITE="http://w1.fi/wpa_supplicant/"
LFS="http://www.linuxfromscratch.org/blfs/view/stable/basicnet/wpa_supplicant.html"
REPOLOGY="wpa-supplicant"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="http://w1.fi/releases/$TARBALL"

BUILD_DEPENDS_arm="openssl-dev libnl-dev"
BUILD_DEPENDS="libnl-dev dbus-dev openssl-dev readline-dev"

compile_rules() {
	cd $src/wpa_supplicant
	cp -a defconfig .config

	# Main build configs
	cat >> .config <<EOT
CONFIG_DEBUG_FILE=y
CONFIG_DEBUG_SYSLOG=y
CONFIG_DEBUG_SYSLOG_FACILITY=LOG_DAEMON
CONFIG_IPV6=y
CONFIG_LIBNL32=y
CONFIG_READLINE=y
CONFIG_WPS=y
CONFIG_AP=y
CONFIG_BGSCAN_SIMPLE=y
EOT
	# Don't use DBUS on ARM arch
	case "$ARCH" in
		arm)
			cat >> .config <<EOT
CFLAGS += -I${sysroot}/usr/include/libnl3
CFLAGS += -I${sysroot}/usr/include/openssl
LIBS += -L${sysroot}/usr/lib
EOT
			;;
		i?86|x86_64)
			cat >> .config <<EOT
CFLAGS += -I/usr/include/libnl3
CONFIG_CTRL_IFACE_DBUS=y
CONFIG_CTRL_IFACE_DBUS_NEW=y
CONFIG_CTRL_IFACE_DBUS_INTRO=y
EOT
			;;
	esac
	make BINDIR=/sbin LIBDIR=/lib || exit 1

	# commands
	bindir="$install/sbin"
	mkdir -p $bindir
	install -vm755 wpa_cli        $bindir
	install -vm755 wpa_passphrase $bindir
	install -vm755 wpa_supplicant $bindir

	cook_pick_manpages \
		doc/docbook/wpa_supplicant.conf.5 \
		doc/docbook/wpa_cli.8 \
		doc/docbook/wpa_passphrase.8 \
		doc/docbook/wpa_supplicant.8

	mkdir -p $install/usr/share/dbus-1/system-services
	install -vm644 dbus/*.service $install/usr/share/dbus-1/system-services/

	mkdir -p $install/etc/dbus-1/system.d
	install -vm644 dbus/dbus-wpa_supplicant.conf \
		$install/etc/dbus-1/system.d/wpa_supplicant.conf

	# Startup script and cleaned up wpa_empty.conf
	cp -a $stuff/etc $install
	install -vm644 $src/wpa_supplicant/wpa_supplicant.conf $install/etc/wpa
	chown -R root:root $install/etc
}

genpkg_rules() {
	copy @std
	DEPENDS="dbus openssl libnl ncurses readline"
	CONFIG_FILES="/etc/wpa/wpa_supplicant.conf"
	TAGS="wireless wifi network"
	case "$SLITAZ_ARCH" in
		arm*) DEPENDS="openssl libnl";;
	esac
}

post_install() {
	grep -qs ^WPA_OPTIONS= $1/etc/daemons.conf || cat >> "$1/etc/daemons.conf" <<"EOT"

# wpa_supplicant daemon options
WPA_OPTIONS="-B -u -P /var/run/wpa_supplicant.pid -c /etc/wpa/wpa.conf -i $(. /etc/network.conf; echo $WIFI_INTERFACE)"

EOT
	# We use /etc/wpa/wpa.conf from SliTaz 5.0
	sed -i 's|/etc/wpa_supplicant.conf|/etc/wpa/wpa.conf|' "$1/etc/daemons.conf" 2>/dev/null
	# 'w' option don't exist anymore with < 0.6.9
	sed -i 's|-Bw|-B|' "$1/etc/daemons.conf" 2>/dev/null
	sed -i 's|-B -w|-B|g' "$1/etc/init.d/network.sh" 2>/dev/null
}
