# SliTaz package receipt v2.

PACKAGE="mesa17"
VERSION="17.2.4"
CATEGORY="x-window"
SHORT_DESC="Open-source implementaton of OpenGL"
MAINTAINER="al.bobylev@gmail.com"
LICENSE="MIT"
WEB_SITE="https://www.mesa3d.org/"
LFS="http://www.linuxfromscratch.org/blfs/view/stable/x/mesa.html"

TARBALL="mesa-$VERSION.tar.xz"
WGET_URL="https://mesa.freedesktop.org/archive/$TARBALL"

BUILD_DEPENDS="autoconf automake libtool python libdrm-dev libgcrypt-dev \
eudev-dev xorg-glproto xorg-dri2proto xorg-dri3proto xorg-presentproto \
xorg-libxcb-dev xorg-libxshmfence-dev xorg-libX11-dev xorg-libXext-dev \
xorg-libXdamage-dev xorg-libXfixes-dev xorg-libXxf86vm-dev expat-dev \
elfutils-dev llvm-dev xorg-libpciaccess-dev wayland-dev libva-dev libvdpau-dev \
zlib-dev"
SPLIT="mesa17-dri mesa17-libegl mesa17-libgbm mesa17-osmesa mesa17-libswrAVX \
mesa17-libwayland-egl mesa17-libxatracker mesa17-vdpau mesa17 mesa17-dev"

compile_rules() {
	# Removed from the full list: freedreno,vc4
	# because we haven't appropriate libdrm-* packages (they are only for ARM)
	GLL_DRV="i915,nouveau,r300,r600,radeonsi,svga,swrast,swr,virgl,etnaviv,imx"

	sed -i "/pthread_stubs_possible=/s/yes/no/" configure.ac
	./autogen.sh \
		CFLAGS='-O2' CXXFLAGS='-O2' \
		--prefix=/usr \
		--sysconfdir=/etc \
		--enable-texture-float \
		--enable-gles1 \
		--enable-gles2 \
		--enable-osmesa \
		--enable-xa \
		--enable-gbm \
		--enable-glx-tls \
		--with-platforms="drm,x11,wayland" \
		--with-gallium-drivers=$GLL_DRV &&

	unset GLL_DRV &&

	make && make install &&
	cook_pick_docs docs/* &&

	mkdir -p $install/etc/X11/xorg.conf.d &&
	cp $stuff/90-DRI.conf $install/etc/X11/xorg.conf.d
}

genpkg_rules() {
	case $PACKAGE in
		*-dri)
			copy lib/dri/ 90-DRI.conf
			CAT="x-window|Direct Rendering Infrastructure"
			DEPENDS="elfutils expat libdrm libdrm-amdgpu libdrm-etnaviv \
			libdrm-intel libdrm-nouveau libdrm-radeon llvm-libs mesa17 \
			xorg-libX11 xorg-libXau xorg-libXdmcp xorg-libpciaccess \
			xorg-libxcb xorg-libxshmfence zlib"
			PROVIDE="mesa-dri"
			;;
		*-libegl)
			copy libEGL.so*
			CAT="x-window|EGL library"
			DEPENDS="expat libdrm libffi mesa17-libgbm wayland xorg-libX11 \
			xorg-libXau xorg-libXdmcp xorg-libxcb xorg-libxshmfence"
			PROVIDE="libegl libegl-mesa mesa-libegl"
			;;
		*-libgbm)
			copy libgbm.so*
			CAT="x-window|Graphics Buffer Manager library"
			DEPENDS="expat libdrm libffi wayland"
			PROVIDE="mesa-libgbm"
			;;
		*-osmesa)
			copy libOSMesa.so*
			CAT="x-window|Off-screen Rendering library"
			DEPENDS="mesa17 zlib"
			PROVIDE="mesa-osmesa"
			;;
		*-libwayland-egl)
			copy libwayland-egl.so*
			CAT="x-window|Wayland EGL library"
			DEPENDS=" "
			PROVIDE="mesa-libwayland-egl"
			;;
		*-libxatracker)
			copy libxatracker.so*
			CAT="x-window|Xorg Gallium3D acceleration library"
			DEPENDS="expat libdrm libdrm-intel libdrm-nouveau llvm-libs \
			xorg-libpciaccess zlib"
			PROVIDE="mesa-libxatracker"
			;;
		*-vdpau)
			copy lib/vdpau/
			CAT="x-window|VDPAU drivers"
			DEPENDS="elfutils expat libdrm libdrm-amdgpu libdrm-nouveau \
			libdrm-radeon llvm-libs xorg-libX11 xorg-libXau xorg-libXdmcp \
			xorg-libxcb xorg-libxshmfence zlib"
			PROVIDE="mesa-vdpau"
			;;
		*-libswrAVX)
			copy libswrAVX*so*
			CAT="x-window|Fast software rendering driver for CPU with AVX"
			DEPENDS="mesa17 llvm-libs"
			;;
		mesa17)
			copy @std
			remove_already_packed
			CAT="x-window|main OpenGL libraries"
			DEPENDS="expat libdrm xorg-libX11 xorg-libXau \
			xorg-libXdamage xorg-libXdmcp xorg-libXext xorg-libXfixes \
			xorg-libXxf86vm xorg-libxcb xorg-libxshmfence zlib"
			SUGGESTED="nvidia"
			PROVIDE="libgl mesa"
			CONFIG_FILES="/etc/drirc"
			;;
		*-dev)
			copy @dev
			DEPENDS="mesa17 mesa17-dri mesa17-libegl mesa17-libgbm \
			mesa17-osmesa mesa17-libwayland-egl mesa17-libxatracker \
			mesa17-vdpau \
			expat-dev libdrm-dev libffi-dev llvm-dev wayland-dev \
			xorg-libX11-dev xorg-libXau-dev xorg-libXdamage-dev \
			xorg-libXdmcp-dev xorg-libXext-dev xorg-libXfixes-dev \
			xorg-libXxf86vm-dev xorg-libpciaccess-dev xorg-libxcb-dev \
			xorg-libxshmfence-dev zlib-dev"
			PROVIDE="mesa-dev"
			;;
	esac
}
