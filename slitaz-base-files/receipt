# SliTaz package receipt v2.

PACKAGE="slitaz-base-files"
VERSION="332"
CATEGORY="base-system"
SHORT_DESC="Linux tree and the necessary files for the base system"
MAINTAINER="pankso@slitaz.org"
LICENSE="BSD GPL3"
WEB_SITE="http://www.slitaz.org/"
HOST_ARCH="i486 arm"

TARBALL="$PACKAGE-$VERSION.tar.bz2"
WGET_URL="http://hg.slitaz.org/$PACKAGE/archive/$VERSION.tar.bz2"

BUILD_DEPENDS="gettext"

# Rules to configure and make the package.
compile_rules()
{
	make DESTDIR=$install install

	for i in /bin /dev /home /media/cdrom /media/flash /media/usbdisk /mnt \
	/proc /root /run /sbin /sys /tmp /usr/bin /usr/games /usr/lib /usr/sbin \
	/usr/share/doc /var/cache /var/games /var/lib /var/lock /var/log/slitaz \
	/var/spool /var/tmp /var/run
	do
		mkdir -p $install$i
	done

	# Create /etc/mtab symlink
	ln -s /proc/mounts $install/etc/mtab

	# Add httphelper link
	ln -s httphelper.sh $install/usr/lib/slitaz/httphelper

	# Populate /dev with $fs/sbin/mktazdevs.sh.
	# Not required with udev.
	# $fs/sbin/mktazdevs.sh $fs/dev

	# Update copyright year
	grep -rl 'copy; 2' $install/var/www | xargs \
		sed -i "s/copy; [0-9]*/copy; $(date +%Y)/"

	# Set release
	echo 'next' > $install/etc/slitaz-release

	chown -R root:root $install
	chmod 1777 $install/tmp
	chmod  640 $install/etc/shadow
	chmod  640 $install/etc/gshadow
	chmod 0750 $install/root
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	cp -a $install/* $fs
	DEPENDS="gettext-base"
	CONFIG_FILES="/etc/adduser.conf /etc/passwd /etc/fstab /etc/issue \
	/etc/hosts /etc/host.conf /etc/hostname /etc/group /etc/gshadow \
	/etc/shadow /etc/daemons.conf /etc/nsswitch.conf /etc/networks \
	/etc/profile /etc/securetty /etc/services /etc/shells"
}

# Pre and post install to backup all /etc settings
#
pre_install() {
	cp -a "$1/etc" "$1/tmp/etc.bak" 2>/dev/null
	[ -x "$1/usr/bin/sudo" ] && mv "$1/usr/bin/sudo" "$1/usr/bin/sudo.orig"
	# Remove old /var/run symlink
	[ -h "$1/var/run" ] && rm -f "$1/var/run"
	:
}

post_install() {
	if cp -a "$1/tmp/etc.bak"/* "$1/etc"; then
		rm -r "$1/tmp/etc.bak"
	fi 2>/dev/null

	[ -x "$1/usr/bin/sudo.orig" ] &&
	mv -f "$1/usr/bin/sudo.orig" "$1/usr/bin/sudo"

	# Reset permission.
	chmod 640 "$1/etc/shadow"
	chmod 640 "$1/etc/gshadow"

	if ! grep -q audio "$1/etc/group"; then
		chroot "$1/" /bin/addgroup -g 20 audio
	fi
}

# We can not remove this package!
pre_remove() {
	exit 1
}
