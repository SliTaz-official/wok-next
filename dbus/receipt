# SliTaz package receipt v2.

PACKAGE="dbus"
VERSION="1.10.14"
CATEGORY="x-window"
SHORT_DESC="D-Bus, a message bus system"
MAINTAINER="pankso@slitaz.org"
LICENSE="GPL2"
WEB_SITE="https://www.freedesktop.org/wiki/Software/dbus/"
HOST_ARCH="i486 arm"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="https://dbus.freedesktop.org/releases/dbus/$TARBALL"

BUILD_DEPENDS="expat-dev xorg-libX11-dev"
SPLIT="dbus-helper dbus dbus-dev"

# Rules to configure and make the package.
compile_rules()
{
	./configure \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--disable-doxygen-docs \
		--disable-xml-docs \
		--disable-static \
		--disable-systemd \
		--without-systemdsystemunitdir \
		--without-console-auth-dir \
		--docdir=/usr/share/doc/dbus-$VERSION \
		$CONFIGURE_ARGS &&
	make && make -j1 install

	# Init script
	cp -a $stuff/etc $install
	chown -R root.root $install/etc
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	case $PACKAGE in
		dbus-helper)
			copy dbus-daemon-launch-helper
			CAT="x-window|dbus-daemon-launch-helper"
			DEPENDS="dbus expat"
			;;
		dbus)
			copy @std
			remove_already_packed
			DEPENDS="expat xorg-libX11   slitaz-base-files"
			CONFIG_FILES="/etc/dbus-1/session.conf /etc/dbus-1/system.conf /etc/dbus-1/system.d/"
			;;
		*-dev) copy @dev;;
	esac
}

pre_install_dbus() {
	# Go for echoing on configuration files if any messagebus user
	# was found.
	if ! grep -qs 'messagebus' "$1/etc/passwd"; then
		action 'Adding user: messagebus...'
		chroot "$1/" addgroup -g25 -S messagebus
		chroot "$1/" adduser -h/var/run/dbus -S -D -u25 \
			-g"D-Bus Message Daemon User" messagebus
		status
	fi
	if ! grep -qs ^DBUS_OPTIONS "$1/etc/daemons.conf"; then
		action 'Configuring %s/etc/daemons.conf...' "$1"
		cat >> "$1/etc/daemons.conf" <<EOT
# DBUS daemon options.
DBUS_OPTIONS="--system"

EOT
		status
	fi
	mkdir -p "$1/var/run" "$1/var/lib/dbus"
}

post_install_dbus() {
	# Mount /dev to fix an error:
	# Failed to generate UUID: Could not open /dev/urandom: Permission denied
	[ -z "$1" ] || mount -o bind /dev "$1/dev"
	chroot "$1/" dbus-uuidgen --ensure
	[ -z "$1" ] || umount "$1/dev"
}

pre_remove_dbus() {
	if [ -z "$1" ]; then
		/etc/init.d/dbus stop
	fi 2>/dev/null
	chroot "$1/" deluser  messagebus
	chroot "$1/" delgroup messagebus
}

post_install_dbus_helper() {
	local i="$1/usr/libexec/dbus-daemon-launch-helper"
	chown root:messagebus $i
	chmod 4750 $i
}
