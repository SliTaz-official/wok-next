# SliTaz package receipt.

PACKAGE="dbus"
VERSION="1.10.14"
CATEGORY="x-window"
SHORT_DESC="D-Bus, a message bus system"
MAINTAINER="pankso@slitaz.org"
LICENSE="GPL2"
WEB_SITE="https://www.freedesktop.org/wiki/Software/dbus/"
HOST_ARCH="i486 arm"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="https://dbus.freedesktop.org/releases/dbus/$TARBALL"

DEPENDS="expat xorg-libX11 slitaz-base-files"
BUILD_DEPENDS="expat-dev xorg-libX11-dev"
SPLIT="dbus-helper"

# Rules to configure and make the package.
compile_rules()
{
	./configure \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--disable-doxygen-docs \
		--disable-xml-docs \
		--disable-static \
		--disable-systemd \
		--without-systemdsystemunitdir \
		--with-console-auth-dir=/run/console/ \
		--docdir=/usr/share/doc/dbus-$VERSION \
		$CONFIGURE_ARGS &&
	make && make -j 1 install
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	cook_copy_folders var bin dbus-1
	cook_copy_files *.so*

	# Init script
	cp -a $stuff/etc $fs

	chown -R root.root $fs
}

pre_install()
{
	# Go for echoing on configuration files if any messagebus user
	# was found.
	if ! grep -qs 'messagebus' "$1/etc/passwd"; then
		action 'Adding user: messagebus...'
		echo 'messagebus:x:18:18:D-Bus Message Daemon User:/var/run/dbus:/bin/false' >> "$1/etc/passwd"
		echo 'messagebus:!:14013:0:99999:7:::' >> "$1/etc/shadow"
		echo 'messagebus:x:18:' >> "$1/etc/group"
		echo 'messagebus:!::' >> "$1/etc/gshadow"
		status
	fi
	if ! grep -qs ^DBUS_OPTIONS "$1/etc/daemons.conf"; then
		action 'Configuring %s/etc/daemons.conf...' "$1"
		cat >> "$1/etc/daemons.conf" <<EOT
# DBUS daemon options.
DBUS_OPTIONS="--system"

EOT
		status
	fi
	[ -d "$1/var/run" ] || mkdir -p "$1/var/run"
}

pre_remove()
{
	if [ -z "$1" ]; then
		/etc/init.d/dbus stop 2>/dev/null
		deluser messagebus
	fi
}
