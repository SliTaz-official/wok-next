# SliTaz package receipt v2.

PACKAGE="xorg-server"
VERSION="1.19.3"
CATEGORY="x-window"
SHORT_DESC="X server"
MAINTAINER="pankso@slitaz.org"
LICENSE="MIT"
WEB_SITE="https://www.x.org/wiki/"
LFS="http://www.linuxfromscratch.org/blfs/view/stable/x/xorg-server.html"

TARBALL="$PACKAGE-$VERSION.tar.bz2"
WGET_URL="$XORG_MIRROR/xserver/$TARBALL"

BUILD_DEPENDS="patch xorg-util-macros xorg-pixman-dev eudev-dev dbus-dev \
xorg-dri2proto xorg-dri3proto xorg-libxshmfence-dev libdrm-dev xorg-libX11-dev \
xorg-glproto mesa17-dev xorg-libXdmcp-dev libgcrypt-dev xorg-xcmiscproto \
xorg-bigreqsproto xorg-randrproto xorg-renderproto xorg-fontsproto \
xorg-videoproto xorg-compositeproto xorg-recordproto xorg-scrnsaverproto \
xorg-resourceproto xorg-xf86driproto xorg-presentproto xorg-xineramaproto \
xorg-libxkbfile-dev xorg-libXfont2-dev xorg-libpciaccess-dev \
xorg-libXxf86dga-dev xorg-libdmx-dev xorg-libXaw-dev xorg-libXpm-dev \
xorg-libXtst-dev xorg-libXres-dev \
xorg-libXmu-dev xorg-libXext-dev xorg-libXrender-dev \
xorg-libXfixes-dev xorg-libXi-dev xorg-dmxproto xorg-libXau-dev \
xorg-libXdmcp-dev libepoxy-dev tslib-dev xorg-xcb-util-renderutil-dev \
xorg-xcb-util-dev xorg-xcb-util-image-dev xorg-xcb-util-wm-dev \
xorg-xcb-util-keysyms-dev expat-dev xorg-xtrans"
SPLIT="xorg-server-Xdmx xorg-server-Xephyr xorg-server-Xfbdev \
xorg-server-Xnest xorg-server-Xvfb xorg-server-module-glamor xorg-server-dev \
xorg-server"
COOKOPTS="skip-log-errors"

compile_rules() {
	fix ld
	./configure \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--disable-static \
		--enable-glamor \
		--enable-install-setuid \
		--enable-suid-wrapper \
		--disable-systemd-logind \
		--disable-xwayland \
		--disable-docs --disable-devel-docs \
		--with-xkb-output=/var/lib/xkb \
		--enable-tslib \
		--enable-dmx \
		--enable-kdrive \
		--enable-kdrive-kbd \
		--enable-kdrive-mouse \
		--enable-kdrive-evdev \
		--enable-xfbdev \
		--enable-xephyr \
		--enable-config-udev \
		--with-fontrootdir=/usr/share/fonts/X11 \
		--with-os-name="SliTaz GNU/Linux" \
		--with-vendor-web="http://www.slitaz.org/" \
		--with-builder-addr="devel@slitaz.org" \
		$CONFIGURE_ARGS &&
	fix libtool &&
	make && make DESTDIR=$install install &&

	mkdir -pv $install/etc/X11/xorg.conf.d
}

genpkg_rules() {
	case $PACKAGE in
		*-Xdmx)
			copy Xdmx
			# chmod 4711 $fs/usr/bin/Xdmx
			CAT="x-window|DMX X server"
			DEPENDS="libgcrypt xorg-libX11 xorg-libXau xorg-libXdmcp \
			xorg-libXext xorg-libXfixes xorg-libXfont2 xorg-libXi xorg-libXmu \
			xorg-libXrender xorg-pixman"
			;;
		*-Xephyr)
			copy Xephyr
			# chmod 4711 $fs/usr/bin/Xephyr
			CAT="x-window|Xephyr X server"
			DEPENDS="eudev libepoxy libgcrypt mesa17 xorg-libX11 xorg-libXau \
			xorg-libXdmcp xorg-libXfont2 xorg-libxcb xorg-libxshmfence \
			xorg-pixman xorg-xcb-util xorg-xcb-util-image \
			xorg-xcb-util-keysyms xorg-xcb-util-renderutil xorg-xcb-util-wm"
			;;
		*-Xfbdev)
			copy Xfbdev
			# chmod 4711 $fs/usr/bin/Xfbdev
			CAT="x-window|Xfbdev framebuffer X server"
			DEPENDS="eudev libgcrypt tslib xorg-libXau xorg-libXdmcp \
			xorg-libXfont2 xorg-pixman"
			;;
		*-Xnest)
			copy Xnest
			# chmod 4711 $fs/usr/bin/Xnest
			CAT="x-window|Xnest X server"
			DEPENDS="libgcrypt xorg-libX11 xorg-libXau xorg-libXdmcp \
			xorg-libXext xorg-libXfont2 xorg-pixman"
			;;
		*-Xvfb)
			copy Xvfb
			# chmod 4711 $fs/usr/bin/Xvfb
			CAT="x-window|Xvfb X server"
			DEPENDS="libgcrypt mesa17 xorg-libXau xorg-libXdmcp xorg-libXfont2 \
			xorg-pixman"
			;;
		*-module-glamor)
			copy libglamoregl.so libglx.so
			CAT="x-window|Glamor DIX (Device Independent X) module"
			DEPENDS="libdrm libepoxy mesa17 mesa17-libgbm"
			;;
		*-dev)
			copy @dev protocol.txt
			DEPENDS="xorg-server xorg-server-Xdmx xorg-server-Xephyr \
			xorg-server-Xfbdev xorg-server-Xnest xorg-server-Xvfb \
			xorg-server-module-glamor \
			mesa17-dev xorg-dri2proto xorg-dri3proto xorg-fontsproto \
			xorg-glproto xorg-inputproto xorg-kbproto xorg-libpciaccess-dev \
			xorg-pixman-dev xorg-presentproto xorg-randrproto xorg-renderproto \
			xorg-resourceproto xorg-scrnsaverproto xorg-videoproto \
			xorg-xextproto xorg-xf86driproto xorg-xineramaproto xorg-xproto"
			;;
		*-server)
			copy @std var/log/ xorg.conf.d/ @rm
			CAT="x-window|core X server"
			DEPENDS="eudev libdrm libgcrypt xorg-libX11 xorg-libXau \
			xorg-libXaw xorg-libXdmcp xorg-libXfont2 xorg-libXt xorg-libdmx \
			xorg-libpciaccess xorg-libxshmfence xorg-pixman   \
			xorg-xkeyboard-config xorg-xkbcomp"
			SUGGESTED="xorg-xf86-input-evdev xorg-xf86-video-vesa"
			;;
	esac
}

post_install_xorg_server() {
	install -dm1777 -oroot -groot "$1/tmp/.ICE-unix" "$1/tmp/.X11-unix"
}
post_install_xorg_server_Xdmx() {
	install -dm1777 -oroot -groot "$1/tmp/.ICE-unix" "$1/tmp/.X11-unix"
}
post_install_xorg_server_Xephyr() {
	install -dm1777 -oroot -groot "$1/tmp/.ICE-unix" "$1/tmp/.X11-unix"
}
post_install_xorg_server_Xfbdev() {
	install -dm1777 -oroot -groot "$1/tmp/.ICE-unix" "$1/tmp/.X11-unix"
}
post_install_xorg_server_Xnest() {
	install -dm1777 -oroot -groot "$1/tmp/.ICE-unix" "$1/tmp/.X11-unix"
}
post_install_xorg_server_Xvfb() {
	install -dm1777 -oroot -groot "$1/tmp/.ICE-unix" "$1/tmp/.X11-unix"
}
