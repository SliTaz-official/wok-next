# SliTaz package receipt v2.

PACKAGE="cacerts"
VERSION="20170620"
CATEGORY="security"
SHORT_DESC="Certificate Authority Certificates"
MAINTAINER="al.bobylev@gmail.com"
LICENSE="MPL2"
WEB_SITE="http://www.linuxfromscratch.org/blfs/view/svn/postlfs/cacerts.html"
HOST_ARCH="any"

TARBALL="$PACKAGE-$VERSION.txt"
#WGET_URL="https://hg.mozilla.org/releases/mozilla-release/file/default/security/nss/lib/ckfw/builtins/certdata.txt"
WGET_URL="http://anduin.linuxfromscratch.org/BLFS/other/certdata.txt"

BUILD_DEPENDS="perl openssl locale-en"

# Rules to configure and make the package.
compile_rules()
{
	mv -f *.txt certdata.txt
	act_version=$(sed -n '/\$Revision:/s|.*Revision: \([0-9]*\).*$|\1|p' certdata.txt)
	echo -e "\nActual version: $act_version\n"
	[ "$VERSION" == "$act_version" ] || echo -e "Warning: Please update receipt!\n"

	cp -a $stuff/* $src
	./make-ca.sh &&
	./remove-expired-certs.sh $src/certs

	mkdir -p $install/etc/ssl/certs
	cp -a $src/certs/*.pem   $install/etc/ssl/certs
	cp -a $src/ca-bundle.crt $install/etc/ssl
	ln -s ../ca-bundle.crt   $install/etc/ssl/certs/ca-certificates.crt
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	copy @std
	DEPENDS="openssl"
}

# Rehash certificates.
# Use simplified plain shell equivalent to the Perl `c_rehash`
# (see openssl package). Normal no output here.
post_install() {
	cd "$1/etc/ssl/certs"
	find . -type l -delete
	for i in $(ls *.pem); do
		j="$(openssl x509 -hash -noout -in $i)"
		[ -n "$j" ] && ln -s $i $j.0
	done
}

# Remove broken symlinks
post_remove() {
	find "$1/etc/ssl/certs" -type l ! -exec test -e \{\} \; -delete
}
