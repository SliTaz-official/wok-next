# SliTaz package receipt.

PACKAGE="gtk+3"
VERSION="3.20.9"
CATEGORY="x-window"
SHORT_DESC="The GIMP Toolkit 3.x"
MAINTAINER="pankso@slitaz.org"
LICENSE="LGPL2"
WEB_SITE="https://www.gtk.org/"
CONFIG_FILES="/etc/gtk-3.0/settings.ini"
SUGGESTED="cups"
COOKOPTS="!menus"

TARBALL="gtk+-$VERSION.tar.xz"
WGET_URL="$GNOME_MIRROR/gtk+/${VERSION:0:4}/$TARBALL"

#HOST_ARCH="i486 arm"
CROSS_BUGS="bug: /bin/bash: no: command not found"

DEPENDS="colord at-spi2-atk at-spi2-core atk bzlib cairo dbus eudev fontconfig \
freetype gdk-pixbuf glib harfbuzz lcms2 libcups libepoxy libffi \
libgnutls liblzma libpng libxcb libxml2 pango pcre pixman xorg-libX11 \
xorg-libXau xorg-libXcomposite xorg-libXdamage xorg-libXdmcp xorg-libXext \
xorg-libXfixes xorg-libXi xorg-libXinerama xorg-libXrandr xorg-libXrender zlib"
BUILD_DEPENDS="glib-dev atk-dev pango-dev cairo-dev gdk-pixbuf-dev gettext \
xorg-libXinerama-dev xorg-libXi-dev xorg-libXrandr-dev xorg-libXcomposite-dev \
xorg-libXdamage-dev libepoxy-dev at-spi2-atk-dev cups-dev colord-dev gtk-doc \
libxslt"
BUILD_DEPENDS_arm="atk-dev pango-dev gdk-pixbuf-dev dbus-dev dbus-glib-dev \
xorg-inputproto"
SPLIT="gtk+3-demo gtk+3-widget-factory gtk+3-icon-browser gtk+3-dev"

# Handle cross compilation.
case "$ARCH" in
	arm*)
		BUILD_DEPENDS="$BUILD_DEPENDS_arm"
		ARCH_ARGS="--enable-introspection=no --disable-glibtest --disable-cups \
--disable-papi --with-xinput gio_can_sniff=yes"
		export LDFLAGS="$LDFLAGS -L/cross/$ARCH/sysroot/usr/lib"
		export CPPFLAGS="$CPPFLAGS -I/cross/$ARCH/sysroot/usr/include" ;;
esac

# Rules to configure and make the package.
compile_rules()
{
	./configure \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--enable-debug=no \
		--enable-xkb \
		--enable-xinerama \
		--enable-xrandr \
		--enable-xfixes \
		--enable-xcomposite \
		--enable-xdamage \
		--enable-x11-backend \
		--enable-introspection \
		--enable-colord \
		--disable-wayland-backend \
		--disable-broadway-backend \
		--with-x \
		$CONFIGURE_ARGS $ARCH_ARGS &&
	make $MAKEFLAGS &&
	make DESTDIR=$DESTDIR install

	find $install -name '*.desktop' | xargs sed -i '/NoDisplay/d'
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	copy etc/ bin/ themes/ *.so* *.xml

	cp -f $stuff/settings.ini $fs/etc/gtk-3.0
	find $fs \( -name '*demo*' -o -name 'gtk3-icon*' -o -name '*widget*' \
		-o -name '*Demo*' -o -name '*exampleapp*' \) -delete
}

post_install()
{
	chroot "$1/" /usr/bin/gtk-query-immodules-3.0 --update-cache
}
