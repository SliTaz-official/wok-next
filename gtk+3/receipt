# SliTaz package receipt v2.

PACKAGE="gtk+3"
VERSION="3.22.8"
CATEGORY="x-window"
SHORT_DESC="The GIMP Toolkit 3.x"
MAINTAINER="pankso@slitaz.org"
LICENSE="LGPL2"
WEB_SITE="https://www.gtk.org/"
LFS="http://www.linuxfromscratch.org/blfs/view/stable/x/gtk3.html"
REPOLOGY="gtk3"

TARBALL="gtk+-$VERSION.tar.xz"
WGET_URL="$GNOME_MIRROR/gtk+/${VERSION%.*}/$TARBALL"

BUILD_DEPENDS_arm="atk-dev pango-dev gdk-pixbuf-dev dbus-dev dbus-glib-dev \
xorg-xorgproto"
BUILD_DEPENDS="glib-dev atk-dev pango-dev cairo-dev gdk-pixbuf-dev gettext \
xorg-libXinerama-dev xorg-libXi-dev xorg-libXrandr-dev xorg-libXcomposite-dev \
xorg-libXdamage-dev libepoxy-dev at-spi2-atk-dev cups-dev colord-dev gtk-doc \
libxslt gobject-introspection-dev xorg-libSM-dev"
SPLIT="gtk+3-demo gtk+3-widget-factory gtk+3-icon-browser gtk+3 gtk+3-dev"
COOKOPTS="skip-log-errors" # Failed to open file ?./gdk.gresource.xml?: No such file or directory
CROSS_BUGS="bug: /bin/bash: no: command not found"

compile_rules() {
	# Handle cross compilation.
	case "$ARCH" in
		arm*)
			ARCH_ARGS="--enable-introspection=no --disable-glibtest \
			--disable-cups --disable-papi --with-xinput gio_can_sniff=yes"
			export LDFLAGS="$LDFLAGS -L/cross/$ARCH/sysroot/usr/lib"
			export CPPFLAGS="$CPPFLAGS -I/cross/$ARCH/sysroot/usr/include"
			;;
	esac

	./configure \
		--disable-debug \
		--enable-xkb \
		--enable-xinerama \
		--enable-xrandr \
		--enable-xfixes \
		--enable-xcomposite \
		--enable-xdamage \
		--enable-x11-backend \
		--enable-introspection \
		--enable-colord \
		--disable-wayland-backend \
		--disable-broadway-backend \
		--with-x \
		$CONFIGURE_ARGS $ARCH_ARGS &&
	fix libtool &&
	make $MAKEFLAGS &&
	make DESTDIR=$DESTDIR install || return 1

	cp -f $stuff/settings.ini $install/etc/gtk-3.0
	find $install -name '*.desktop' | xargs sed -i '/NoDisplay/d'
}

genpkg_rules() {
	case $PACKAGE in
		gtk+3-demo)
			copy gtk3-demo* *Demo* *exampleapp*
			rm -r $fs/usr/share/gtk-doc $fs/usr/share/man
			CAT="development|example code and demo"
			DEPENDS="cairo gdk-pixbuf glib gtk+3 libepoxy libharfbuzz pango"
			;;
		gtk+3-widget-factory)
			copy gtk3-widget*
			rm -r $fs/usr/share/gtk-doc $fs/usr/share/man
			CAT="development|widget factory"
			DEPENDS="atk cairo gdk-pixbuf glib gtk+3"
			;;
		gtk+3-icon-browser)
			copy gtk3-icon-browser gtk3-icon-browser.desktop
			CAT="development|icon browser"
			DEPENDS="glib gtk+3"
			;;
		gtk+3)
			COOKOPTS="!menus"
			copy etc/ bin/ themes/ *.so* *.xml @rm
			DEPENDS="at-spi2-atk atk cairo colord fontconfig gdk-pixbuf glib \
			libcups libepoxy pango xorg-libX11 xorg-libXcomposite \
			xorg-libXdamage xorg-libXext xorg-libXfixes xorg-libXi \
			xorg-libXinerama xorg-libXrandr"
			CONFIG_FILES="/etc/gtk-3.0/settings.ini"
			SUGGESTED="cups"
			;;
		gtk+3-dev)
			copy @dev *.its *.loc *.rng
			DEPENDS="gtk+3 gtk+3-demo gtk+3-icon-browser gtk+3-widget-factory \
			at-spi2-atk-dev atk-dev cairo-dev fontconfig-dev gdk-pixbuf-dev \
			glib-dev libepoxy-dev pango-dev xorg-libX11-dev \
			xorg-libXcomposite-dev xorg-libXdamage-dev xorg-libXext-dev \
			xorg-libXfixes-dev xorg-libXi-dev xorg-libXinerama-dev \
			xorg-libXrandr-dev"
			;;
	esac
}

post_install_gtk_3() {
	chroot "$1/" /usr/bin/gtk-query-immodules-3.0 --update-cache
}
