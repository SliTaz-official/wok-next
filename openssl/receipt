# SliTaz package receipt v2.

PACKAGE="openssl"
VERSION="1.1.0h"
CATEGORY="security"
SHORT_DESC="Open source Secure Sockets Layer"
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="BSD"
WEB_SITE="https://www.openssl.org/"
LFS="http://www.linuxfromscratch.org/blfs/view/svn/postlfs/openssl.html"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="https://www.openssl.org/source/$TARBALL"
# Integrity check: https://www.openssl.org/source/
TARBALL_SHA256="5835626cde9e99656585fc7aaa2302a73a7e1340bf8c14fd635a62c66802a517"

BUILD_DEPENDS_arm=" "
BUILD_DEPENDS="perl zlib-dev"
SPLIT="openssl openssl-dev"

compile_rules() {
	# MAKEFLAGS make OpenSSL build fail.
	unset MAKEFLAGS MAKE_ARGS

	# Add -Wa,--noexecstack here so that libcrypto's assembler modules will be
	# marked as not requiring an executable stack (compatibility improvement).
	case "$ARCH" in
		arm*)   ARCH_ARGS='linux-armv4'
		        MAKE_ARGS="CC=$HOST_SYSTEM-gcc AR=\"$HOST_SYSTEM-ar r\" RANLIB=$HOST_SYSTEM-ranlib";;
		i?86)   ARCH_ARGS='zlib-dynamic linux-elf';;
		x86_64) ARCH_ARGS='zlib-dynamic enable-ec_nistp_64_gcc_128 linux-x86_64';;
	esac

	./Configure \
		--prefix=/usr \
		--openssldir=/etc/ssl \
		--libdir=lib \
		shared zlib enable-md2 no-ssl3-method $ARCH_ARGS \
		"-Wa,--noexecstack $CPPFLAGS $CFLAGS $LDFLAGS" &&

	make depend &&
	make $MAKE_ARGS -j1 &&
	make \
		DESTDIR=$install \
		MANDIR=/usr/share/man \
		install_sw install_ssldirs install_man_docs
}

testsuite() {
	readelf -h $install/usr/bin/openssl
}

genpkg_rules() {
	case $PACKAGE in
		openssl)
			copy @std
			TAGS="SSL security"
			;;
		openssl-dev)
			copy @dev
			;;
	esac
}
