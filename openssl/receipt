# SliTaz package receipt v2.

PACKAGE="openssl"
VERSION="1.0.2l"
CATEGORY="security"
SHORT_DESC="Open source Secure Sockets Layer"
MAINTAINER="pascal.bellard@slitaz.org"
LICENSE="BSD"
WEB_SITE="https://www.openssl.org/"
TAGS="ssl security"
HOST_ARCH="i486 arm"

TARBALL="$PACKAGE-$VERSION.tar.gz"
WGET_URL="https://www.openssl.org/source/$TARBALL"
# Integrity check: https://www.openssl.org/source/
TARBALL_SHA256="ce07195b659e75f4e1db43552860070061f156a98bb37b672b101ba6e3ddf30c"

BUILD_DEPENDS="perl zlib-dev"
BUILD_DEPENDS_arm=" "
SPLIT="libcrypto libcrypto-dev libssl openssl-dev"

# Rules to configure and make the package.
compile_rules()
{
	# MAKEFLAGS make openssl build fail.
	unset MAKEFLAGS

	# Add -Wa,--noexecstack here so that libcrypto's assembler modules will be
	# marked as not requiring an executable stack (compatibility improvement).
	case "$ARCH" in
		arm)
			# BUG: shared libs are not built
			./Configure --prefix=/usr --openssldir=/etc/ssl \
				 shared zlib enable-md2 -Wa,--noexecstack \
				 linux-armv4 &&
			sed -i 's/\(basename .*\)`/\1 || true `/' Makefile &&
			make \
				CC=${HOST_SYSTEM}-gcc \
				AR="${HOST_SYSTEM}-ar r" \
				RANLIB=${HOST_SYSTEM}-ranlib ;;
		i486)
			./config --prefix=/usr --openssldir=/etc/ssl \
				shared zlib zlib-dynamic enable-md2 -Wa,--noexecstack &&
			make depend ;;
	esac &&
	# Install
	make INSTALL_PREFIX=$DESTDIR \
		MANDIR=/usr/share/man CC=${HOST_SYSTEM}-gcc install
}

testsuite()
{
	readelf -h $install/usr/bin/openssl
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	case $PACKAGE in
		openssl)
			copy etc/ bin/ engines/
			DEPENDS="libcrypto libssl"
			;;
		libcrypto)
			copy libcrypto*.so*
			DEPENDS=" "
			CAT="security|general purpose cryptographic library"
			;;
		libcrypto-dev)
			copy libcrypto*.la libcrypto*.pc
			DEPENDS="pkg-config"
			CAT="development|general purpose cryptographic library, development files"
			;;
		libssl)
			copy libssl.so*
			DEPENDS="libcrypto"
			CAT="security|OpenSSL libraries"
			;;
		openssl-dev)
			copy @dev
			find $fs -name 'libcrypto*' -delete
			DEPENDS="libcrypto-dev pkg-config"
			;;
	esac
}
