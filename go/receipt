# SliTaz package receipt v2.

PACKAGE="go"
VERSION="1.2.1"
CATEGORY="development"
SHORT_DESC="The Go programming language (R.Griesemer R.Pike K.Thompson)"
MAINTAINER="domcox@slitaz.org"
LICENSE="BSD"
WEB_SITE="http://www.golang.org"
TARBALL="$PACKAGE$VERSION.src.tar.gz"
WGET_URL="https://go.googlecode.com/files/$TARBALL"

BUILD_DEPENDS="bash bison make ed wget"
SPLIT="go emacs-pkg-go-mode go-sources"

# Rules to configure and make the package.
compile_rules()
{
	cd $src/src

	# Setting up environnment before building go.
	# For more information, see: http://golang.org/doc/install/source

	# Go tree, binaries and scripts locations.
	export GOROOT_FINAL=/usr/lib/go

	# Support all x86 chips (Pentium MMX or later)
	# or optionaly only Pentium 4/Opteron/Athlon 64 or later.
	export GO386=387	# Pentium MMX or later
	# export GO386=sse2	# Pentium 4/Opteron/Athlon 64 or later

	# Target operating system (optional).
	export GOOS=linux

	# Target compilation architecture.
	case $ARCH in
		x86_64)
			# A mature implementation. The compiler has an effective optimizer
			# (registerizer) and generates good code (although gccgo can do
			# noticeably better sometimes).
			export GOARCH="amd64" ;;

		i486)
			# Comparable to the amd64
			export GOARCH="386" ;;

		arm)
			# Supports Linux, FreeBSD and NetBSD binaries. Less widely used
			# than the other ports.
			export GOARCH="arm"
			# ARM11 (VFPv1) or better cores + cross-compiling.
			export GOARM=6 ;;
	esac

	# Build go
	/bin/bash make.bash --no-banner
}

# Rules to gen a SliTaz package suitable for Tazpkg.
genpkg_rules()
{
	case $PACKAGE in
	go)
		TAGS="go"
		DEPENDS=""
		mkdir -p $fs/usr/lib/go/src
		# bin
		cp -a $src/bin $fs/usr
		# go tree
		cp -a $src/pkg $fs/usr/lib/go
		# lib
		cp -a $src/lib $fs/usr/lib/go
		# include
		cp -a $src/include $fs/usr/lib/go
		# pkg
		cp -a $src/src/pkg $fs/usr/lib/go/src
		cp -a $src/src/cmd $fs/usr/lib/go/src
		cp -a $src/src/lib9 $fs/usr/lib/go/src
		;;
	emacs-pkg-go-mode)
		CAT="development|An Emacs major mode for editing Go code."
		TAGS="emacs go"
		DEPENDS="emacs"
		echo -n "Installing start file"
		mkdir -p $fs/usr/share/emacs/site-lisp/site-start.d && \
		cp -a stuff/80-go-init.el $fs/usr/share/emacs/site-lisp/site-start.d
		status

		echo -n "Installing go-mode"
		mkdir -p $fs/usr/share/emacs/site-lisp/go-mode && \
		cp -a $src/misc/emacs/* $fs/usr/share/emacs/site-lisp/go-mode
		status
		;;
	go-sources)
		CAT="development|The Go programming language - Sources files."
		TAGS="go"
		DEPENDS="go"
		# misc
		mkdir -p $fs/usr/lib/go/misc
		for dir in arm cgo goplay swig; do
			cp -a $src/misc/$dir $fs/usr/lib/go/misc
		done

		# test
		cp -a $src/test/ $fs/usr/lib/go

		# doc
		cp -a $src/doc/ $fs/usr/lib/go

		# tools
		mkdir -p $fs/usr/lib/go/src
		cp -a $src/src/*.bash $fs/usr/lib/go/src
		cp -a $src/src/*.rc $fs/usr/lib/go/src
		;;
	esac
}

post_install_emacs_pkg_go_mode()
{
	chroot "$1/" tazpkg reconfigure emacs
}

post_remove_emacs_pkg_go_mode()
{
	chroot "$1/" tazpkg reconfigure emacs
}
